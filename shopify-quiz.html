<div class="aqualivia-quiz" data-api-endpoint="https://primary-production-dae8.up.railway.app/webhook/quiz" data-storefront-token="0932f96dbb3d1ce17ecb1d1816adf97e">
    <h2 class="quiz-section-title">Quiz</h2>
    <form class="quiz-form" novalidate>
      <header class="quiz-header">
        <h1>Design Your AQUALIVIA Water Solution</h1>
        <p>Answer a few practical questions about your home so we can match you with systems that deliver the results you care about most.</p>
        <div class="quiz-progress" role="status" aria-live="polite">
          Step <span class="current-step">1</span> of <span class="total-steps">8</span>
        </div>
      </header>
  
      <section class="quiz-step is-active" data-step="1" data-type="radio" data-question="What is your home's water source?">
        <h2>Question 1: What is your home's water source?</h2>
        <p class="quiz-help">Help us understand the baseline for your water quality.</p>
        <label class="quiz-option">
          <input type="radio" name="q1" value="city" data-answer="City / Municipal Water" required>
          <span>
            <strong>City / Municipal Water</strong>
            <span class="quiz-option-meta">Homes connected to public utilities.</span>
          </span>
        </label>
        <label class="quiz-option">
          <input type="radio" name="q1" value="well" data-answer="Private Well Water">
          <span>
            <strong>Private Well Water</strong>
            <span class="quiz-option-meta">Independent wells with unique treatment needs.</span>
          </span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>

      <section class="quiz-step" data-step="2" data-type="household" data-question="Tell us about your home">
        <h2>Question 2: Tell us about your home</h2>
        <p class="quiz-help">We use these details to size equipment for peak demand and flow rates.</p>

        <div class="quiz-field-grid">
          <div class="quiz-field-group">
            <label class="quiz-field-label" for="home-occupants">Occupants</label>
            <select class="quiz-input" id="home-occupants" name="home-occupants" required>
              <option value="">Select occupants</option>
              <option value="1 person">1 person</option>
              <option value="2 people">2 people</option>
              <option value="3 people">3 people</option>
              <option value="4-5 people">4-5 people</option>
              <option value="6-7 people">6-7 people</option>
              <option value="8+ people">8+ people</option>
            </select>
          </div>

          <div class="quiz-field-group">
            <label class="quiz-field-label" for="home-square-footage">Approximate square footage</label>
            <select class="quiz-input" id="home-square-footage" name="home-square-footage" required>
              <option value="">Select square footage</option>
              <option value="Up to 1,000 sq ft">Up to ~1,000 sq ft</option>
              <option value="Up to 1,500 sq ft">Up to ~1,500 sq ft</option>
              <option value="Up to 2,200 sq ft">Up to ~2,200 sq ft</option>
              <option value="Up to 3,600 sq ft">Up to ~3,600 sq ft</option>
              <option value="Up to 5,200 sq ft">Up to ~5,200 sq ft</option>
              <option value="Up to 6,500 sq ft">Up to ~6,500 sq ft</option>
              <option value="Up to 8,000 sq ft">Up to ~8,000 sq ft</option>
              <option value="Up to 10,000 sq ft">Up to ~10,000 sq ft</option>
              <option value="10,000+ sq ft">10,000+ sq ft</option>
            </select>
          </div>

          <div class="quiz-field-group">
            <label class="quiz-field-label" for="home-stories">Stories</label>
            <select class="quiz-input" id="home-stories" name="home-stories" required>
              <option value="">Select number of stories</option>
              <option value="1 story">1 story</option>
              <option value="2 stories">2 stories</option>
              <option value="3 stories">3 stories</option>
              <option value="4+ stories">4+ stories</option>
            </select>
          </div>

          <div class="quiz-field-group">
            <label class="quiz-field-label" for="home-bathrooms">Full bathrooms</label>
            <select class="quiz-input" id="home-bathrooms" name="home-bathrooms" required>
              <option value="">Select number of bathrooms</option>
              <option value="1 bath">1</option>
              <option value="2 baths">2</option>
              <option value="3 baths">3</option>
              <option value="4 baths">4</option>
              <option value="5+ baths">5+</option>
            </select>
          </div>
        </div>

        <p class="quiz-error" aria-live="polite"></p>
      </section>

      <section class="quiz-step" data-step="3" data-type="checkbox" data-question="What water problems have you noticed?">
        <h2>Question 3: What water problems have you noticed? (Check all that apply)</h2>
        <p class="quiz-help">Select every issue you want to fix so we can target the right treatment.</p>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="hardness" data-answer="Hardness issues (scale, soap scum, dry skin)">
          <span>
            <strong>Hardness issues (scale, soap scum, dry skin)</strong>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="odors-tastes" data-answer="Odors and tastes (sulfur, chlorine, metallic, musty)">
          <span>
            <strong>Odors and tastes (sulfur, chlorine, metallic, musty)</strong>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="staining" data-answer="Staining or discoloration (iron, manganese, copper)">
          <span>
            <strong>Staining or discoloration (iron, manganese, copper)</strong>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="cloudiness" data-answer="Cloudiness or sediment">
          <span>
            <strong>Cloudiness or sediment</strong>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="health" data-answer="Health concerns (PFAS, lead, bacteria)">
          <span>
            <strong>Health concerns (PFAS, lead, bacteria)</strong>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="upgrade" data-answer="No specific issues, I just want the best water">
          <span>
            <strong>No specific issues, I just want the best water</strong>
          </span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>

      <section class="quiz-step" data-step="4" data-type="checkbox" data-question="Where do you want to improve your water?">
        <h2>Question 4: Where do you want to improve your water? (Check all that apply)</h2>
        <p class="quiz-help">Tell us which parts of your home need attention.</p>
        <label class="quiz-option">
          <input type="checkbox" name="q4" value="whole-home" data-answer="The Entire Home: Improve water at every faucet, shower, and appliance.">
          <span>
            <strong>The Entire Home</strong>
            <span class="quiz-option-meta">Improve water at every faucet, shower, and appliance.</span>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q4" value="drinking" data-answer="Drinking &amp; Cooking Water: Focus on high-purity water, typically at the kitchen sink.">
          <span>
            <strong>Drinking &amp; Cooking Water</strong>
            <span class="quiz-option-meta">Focus on high-purity water, typically at the kitchen sink.</span>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q4" value="pfas" data-answer="Extra protection for PFAS and lead">
          <span>
            <strong>Extra protection for PFAS and lead</strong>
            <span class="quiz-option-meta">Add specialized filtration for emerging contaminants.</span>
          </span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>

      <section class="quiz-step" data-step="5" data-type="checkbox" data-question="Are you interested in any of these specific features?">
        <h2>Question 5: Are you interested in any of these specific features? (Check all that apply)</h2>
        <p class="quiz-help">Flag any preferences so we can highlight systems with those benefits.</p>
        <label class="quiz-option">
          <input type="checkbox" name="q5" value="salt-free" data-answer="A salt-free system to prevent scale without using salt.">
          <span>
            <strong>A salt-free system to prevent scale without using salt.</strong>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q5" value="chemical-free" data-answer="Chemical-free disinfection to treat for bacteria and viruses.">
          <span>
            <strong>Chemical-free disinfection to treat for bacteria and viruses.</strong>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q5" value="minerals" data-answer="Adding healthy minerals or making my drinking water alkaline.">
          <span>
            <strong>Adding healthy minerals or making my drinking water alkaline.</strong>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q5" value="no-preference" data-answer="No preference, just recommend the best solution for my issues.">
          <span>
            <strong>No preference, just recommend the best solution for my issues.</strong>
          </span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>

      <section class="quiz-step" data-step="6" data-type="lab" data-question="Lab results (optional)">
        <h2>Step 6: Lab results (optional)</h2>
        <p class="quiz-help">If you have a recent water test, you can upload it or paste your key numbers. This helps us fine-tune your recommendation.</p>

        <div class="quiz-note" role="note">
          <strong>Tip:</strong>
          <span>If you already have a softener, include that in your notes so we don’t suggest a duplicate system.</span>
        </div>

        <div class="quiz-field-group">
          <label class="quiz-field-label" for="lab-file">Upload lab file (PDF or TXT)</label>
          <input class="quiz-file-input" type="file" id="lab-file" name="lab-file" accept=".pdf,.txt,.csv">
          <p class="quiz-field-help">TXT files are read automatically. PDFs are saved with your responses; for faster processing, paste key values below as well.</p>
        </div>

        <div class="quiz-field-group">
          <label class="quiz-field-label" for="lab-values">Or paste lab values</label>
          <textarea class="quiz-textarea" id="lab-values" name="lab-values" placeholder="Example: Hardness 12 gpg, Iron 0.5 mg/L, Manganese 0.06 mg/L, Turbidity 0.3 NTU, pH 7.4, PFAS detected."></textarea>
        </div>

        <p class="quiz-error" aria-live="polite"></p>
      </section>

      <section class="quiz-step" data-step="7" data-type="contact" data-question="Client details">
        <h2>Question 7: Client details</h2>
        <p class="quiz-help">Share the best way to reach you so we can deliver your personalized water system plan.</p>

        <div class="quiz-field-grid">
          <div class="quiz-field-group">
            <label class="quiz-field-label" for="client-name">Full name</label>
            <input class="quiz-input" type="text" id="client-name" name="client-name" autocomplete="name" placeholder="Jane Doe" required>
          </div>

          <div class="quiz-field-group">
            <label class="quiz-field-label" for="client-phone">Phone</label>
            <input class="quiz-input" type="tel" id="client-phone" name="client-phone" autocomplete="tel" placeholder="(555) 123-4567" required>
          </div>

          <div class="quiz-field-group">
            <label class="quiz-field-label" for="client-email">Email</label>
            <input class="quiz-input" type="email" id="client-email" name="client-email" autocomplete="email" placeholder="you@example.com" required>
          </div>

          <div class="quiz-field-group quiz-field-group-full">
            <label class="quiz-field-label" for="client-address">Address</label>
            <textarea class="quiz-textarea" id="client-address" name="client-address" autocomplete="street-address" placeholder="Street, City, State, ZIP" required></textarea>
          </div>
        </div>

        <p class="quiz-error" aria-live="polite"></p>
      </section>
  
      <footer class="quiz-footer">
        <button type="button" class="quiz-button quiz-prev" aria-label="Go to previous question" disabled>Back</button>
        <button type="button" class="quiz-button quiz-next" aria-label="Go to next question">Next</button>
        <button type="submit" class="quiz-button quiz-submit" aria-label="Submit quiz">See My Recommendation</button>
      </footer>
      <p class="quiz-status" aria-live="polite"></p>
    </form>
  
    <section class="quiz-results" hidden>
      <h2>Your Personalized System Picks</h2>
      <p class="quiz-results-help">We matched these products to the challenges you highlighted. Add one to your cart instantly or open the product page for more detail.</p>
      <div class="quiz-results-summary" hidden></div>
      <div class="quiz-results-grid"></div>
    </section>

    <div class="quiz-loading" role="status" aria-live="assertive" hidden>
      <div class="quiz-loading-content">
        <p class="quiz-loading-title">Your system is been built</p>
        <div class="quiz-loading-spinner" aria-hidden="true"></div>
        <p class="quiz-loading-help">Hold tight while we assemble the right combination of AQUALIVIA systems for your home.</p>
      </div>
    </div>
  </div>
  
  <style>@keyframes quiz-spin{0%{transform:rotate(0deg)}to{transform:rotate(360deg)}}.aqualivia-quiz{font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;color:#1d2939;background:#f7fafc;border-radius:16px;padding:32px;max-width:720px;margin:0 auto;box-shadow:0 20px 40px rgba(15,23,42,.08);position:relative}@media (max-width:640px){.aqualivia-quiz{padding:20px}}.quiz-section-title{margin:0 0 24px;font-size:32px;font-weight:700;color:#1d2939;text-align:center}@media (max-width:640px){.quiz-section-title{font-size:28px;margin-bottom:20px}}.quiz-header h1,.quiz-step h2{margin:0 0 8px;font-size:28px;font-weight:700}.quiz-header p{margin:0 0 16px;line-height:1.5}.quiz-progress{font-size:15px;font-weight:600;color:#2563eb}.quiz-step{display:none;margin-top:28px}.quiz-step.is-active{display:block}.quiz-step h2{font-size:22px}.quiz-help{margin:0 0 18px;font-size:15px;color:#475467}.quiz-option{display:block;margin-bottom:12px;padding:16px;border:1px solid #d0d5dd;border-radius:12px;background:#fff;position:relative;cursor:pointer;transition:border-color .2s ease,box-shadow .2s ease}.quiz-option input{position:absolute;opacity:0;pointer-events:none}.quiz-option span{display:block;font-size:16px;line-height:1.4}.quiz-option strong{display:block;font-weight:600;color:#1d2939}.quiz-option-meta{display:block;margin-top:4px;font-size:14px;color:#475467}.quiz-note{margin:0 0 20px;padding:14px 16px;border-radius:12px;background:#eff6ff;border-left:4px solid #2563eb;color:#1d4ed8;font-size:14px;line-height:1.5}.quiz-note strong{color:#1d4ed8;margin-bottom:4px}.quiz-field-group{margin-bottom:20px}.quiz-field-grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}.quiz-field-group-full{grid-column:1/-1}.quiz-field-label{display:block;font-weight:600;margin-bottom:8px;color:#1d2939}.quiz-field-help{margin:6px 0 0;font-size:13px;color:#475467;line-height:1.4}.quiz-input{display:block;width:100%;padding:12px 14px;border-radius:12px;border:1px solid #d0d5dd;font-size:15px;color:#1d2939;background:#fff}.quiz-file-input:focus,.quiz-input:focus,.quiz-textarea:focus{outline:0;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.15)}select.quiz-input{appearance:none;background-image:linear-gradient(45deg,transparent 50%,#2563eb 50%),linear-gradient(135deg,#2563eb 50%,transparent 50%),linear-gradient(to right,#d0d5dd,#d0d5dd);background-position:calc(100% - 18px) calc(50% - 4px),calc(100% - 12px) calc(50% - 4px),calc(100% - 2.2em) 50%;background-size:6px 6px,6px 6px,1px 60%;background-repeat:no-repeat;padding-right:42px;cursor:pointer}select.quiz-input:focus{background-image:linear-gradient(45deg,transparent 50%,#1d4ed8 50%),linear-gradient(135deg,#1d4ed8 50%,transparent 50%),linear-gradient(to right,#1d4ed8,#1d4ed8)}.quiz-file-input,.quiz-textarea{width:100%;border:1px solid #d0d5dd;font-size:15px;background:#fff}.quiz-file-input{display:block;padding:10px 12px;border-radius:10px}.quiz-textarea{min-height:140px;resize:vertical;padding:14px;border-radius:12px;line-height:1.5;color:#1d2939}.quiz-option:focus-within,.quiz-option:hover{border-color:#2563eb;box-shadow:0 12px 24px rgba(37,99,235,.12)}.quiz-option input:checked+span{font-weight:600;color:#1d4ed8}.quiz-error{min-height:20px;font-size:14px;color:#dc2626;margin-top:8px}.has-error .quiz-option{border-color:#dc2626}.quiz-footer{margin-top:32px;display:flex;gap:12px}.quiz-button{flex:1;border:0;border-radius:12px;padding:14px 18px;font-size:16px;font-weight:600;background:#2563eb;color:#fff;cursor:pointer;transition:background .2s ease,transform .2s ease}.quiz-button[disabled]{background:#cbd5f5;cursor:not-allowed;transform:none}.quiz-button.quiz-prev{background:#e0e7ff;color:#1d4ed8;flex:0 0 120px}.quiz-button:hover:not([disabled]){background:#1d4ed8;transform:translateY(-1px)}.quiz-button.quiz-prev:hover:not([disabled]){background:#c3d4ff}.quiz-submit{display:none}.quiz-submit.is-visible{display:block}.quiz-status{margin-top:18px;font-size:15px;color:#1d2939}.quiz-results{margin-top:40px;padding-top:24px;border-top:1px solid #e2e8f0}.quiz-results h2{margin:0 0 8px;font-size:24px;font-weight:700;color:#111827}.quiz-results-help{margin:0 0 24px;color:#475467;font-size:15px}.quiz-results-summary{margin-bottom:28px;padding:20px;border-radius:12px;background:#eef2ff;border:1px solid #c7d2fe;color:#312e81;font-size:15px;line-height:1.6}.quiz-results-summary h3{margin:0 0 12px;font-size:18px;font-weight:600}.quiz-results-summary ul{padding-left:20px;margin:0}.quiz-results-summary li{margin-bottom:6px}.quiz-results-grid{display:grid;gap:20px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}.quiz-card{background:#fff;border-radius:14px;border:1px solid #d0d5dd;box-shadow:0 14px 28px rgba(15,23,42,.08);overflow:hidden;display:flex;flex-direction:column}.quiz-card-image{width:100%;aspect-ratio:4/3;object-fit:contain;background:#f8fafc}.quiz-card-body{padding:18px;flex:1;display:flex;flex-direction:column}.quiz-card-title{margin:0 0 8px;font-size:18px;font-weight:600;color:#1d2939}.quiz-card-explanation{margin:0 0 12px;font-size:14px;line-height:1.5;color:#475467;font-style:italic}.quiz-card-price{font-size:16px;font-weight:600;color:#2563eb;margin-bottom:12px}.quiz-card-actions{margin-top:auto;display:flex;gap:10px}.quiz-card-button{flex:1;border:0;border-radius:10px;padding:12px;font-size:15px;font-weight:600;cursor:pointer;transition:transform .2s ease,background .2s ease,color .2s ease}.quiz-card-button.primary{background:#2563eb;color:#fff}.quiz-card-button.primary:hover:not([disabled]){background:#1d4ed8;transform:translateY(-1px)}.quiz-card-button.secondary{background:#e0e7ff;color:#1d4ed8}.quiz-card-button.secondary:hover{background:#c3d4ff;transform:translateY(-1px)}.quiz-card-button[disabled]{opacity:.7;cursor:not-allowed;transform:none}.quiz-results-empty,.quiz-results-error{grid-column:1/-1;padding:18px;border-radius:12px;background:#fef2f2;border:1px solid #fecaca;color:#991b1b}.quiz-results-empty strong{display:block;margin-bottom:4px}.quiz-has-results .quiz-form,.quiz-has-results .quiz-status{display:none}.quiz-loading{position:absolute;inset:0;background:rgba(255,255,255,.85);display:flex;align-items:center;justify-content:center;z-index:10}.quiz-loading-content{text-align:center;padding:32px;border-radius:16px;background:#fff;box-shadow:0 20px 45px rgba(37,99,235,.18);max-width:360px}.quiz-loading-title{margin:0 0 16px;font-size:18px;font-weight:600;color:#1d4ed8;text-transform:uppercase;letter-spacing:.05em}.quiz-loading-spinner{width:56px;height:56px;margin:0 auto 16px;border-radius:50%;border:5px solid #dbeafe;border-top-color:#2563eb;animation:quiz-spin 1s linear infinite}.quiz-loading-help{margin:0;font-size:14px;color:#475467;line-height:1.5}</style>
  
  <script>!function(){const e=document.querySelector(".aqualivia-quiz");if(!e)return;const t=e.dataset.apiEndpoint,r=e.dataset.partsUrl||"/collections/parts-and-filters",n=e.querySelector(".quiz-form"),o=Array.from(e.querySelectorAll(".quiz-step")),a=o.length,s=5242880,i=e.querySelector(".quiz-next"),l=e.querySelector(".quiz-prev"),c=e.querySelector(".quiz-submit"),u=e.querySelector(".current-step"),d=e.querySelector(".total-steps"),p=e.querySelector(".quiz-status"),m=e.querySelector(".quiz-results"),h=e.querySelector(".quiz-results-summary"),y=e.querySelector(".quiz-results-grid"),f=e.querySelector(".quiz-loading");let g=0;function q(e){p&&(p.textContent=e)}function b(){l&&(l.disabled=g<=0);const e=!(a>0)||g>=a-1;if(i&&(i.style.display=e?"none":"block"),c&&c.classList.toggle("is-visible",e),u){const e=a>0?Math.min(g+1,a):0;u.textContent=e}}function S(e){if(!a)return g=0,void b();const t=Math.max(0,Math.min(e,a-1));o.forEach((e,r)=>{e.classList.toggle("is-active",r===t),e.classList.remove("has-error");const n=e.querySelector(".quiz-error");n&&(n.textContent="")}),g=t,b()}function w(e){if(!e)return[];const t=e.dataset.type,r=e.querySelector('input[type="file"]');if(r){const e=r.files?.[0];if(e&&e.size>s)return!1}if("checkbox"===t)return Array.from(e.querySelectorAll('input[type="checkbox"]:checked')).map(e=>e.dataset.answer);const n=e.querySelector('input[type="radio"]:checked');return n?[n.dataset.answer]:[]}function v(e){const t=o[e];if(!t)return!0;const r=t.querySelector(".quiz-error"),n=w(t),a=t.dataset.type;if("lab"===a){const e=t.querySelector('input[type="file"]'),n=e?.files?.[0];return n&&n.size>s?(t.classList.add("has-error"),r&&(r.textContent=`Please upload a file smaller than ${x(s)}.`),!1):(t.classList.remove("has-error"),r&&(r.textContent=""),!0)}if("household"===a)return[t.querySelector("#home-occupants"),t.querySelector("#home-square-footage"),t.querySelector("#home-stories"),t.querySelector("#home-bathrooms")].filter(e=>!e?.value).length?(t.classList.add("has-error"),r&&(r.textContent="Please complete each field so we can size your system correctly."),!1):(t.classList.remove("has-error"),r&&(r.textContent=""),!0);if("contact"===a){const e=t.querySelector("#client-name"),n=t.querySelector("#client-phone"),o=t.querySelector("#client-email"),a=t.querySelector("#client-address"),s=[];if(e?.value.trim()||s.push("name"),n?.value.trim()||s.push("phone"),o?.value.trim()||s.push("email"),a?.value.trim()||s.push("address"),s.length)return t.classList.add("has-error"),r&&(r.textContent="Please complete all contact details so we can follow up with your personalized plan."),!1;const i=o.value.trim();return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)?n.value.trim().replace(/[^0-9]/g,"").length<10?(t.classList.add("has-error"),r&&(r.textContent="Please enter a phone number with at least 10 digits."),n.focus(),!1):(t.classList.remove("has-error"),r&&(r.textContent=""),!0):(t.classList.add("has-error"),r&&(r.textContent="Please enter a valid email address."),o.focus(),!1)}return"checkbox"===a&&0===n.length?(t.classList.add("has-error"),r&&(r.textContent="Please select at least one option."),!1):"radio"===a&&0===n.length?(t.classList.add("has-error"),r&&(r.textContent="Please select one option to continue."),!1):(t.classList.remove("has-error"),r&&(r.textContent=""),!0)}function x(e){if(!Number.isFinite(e))return`${e} bytes`;const t=["bytes","KB","MB","GB","TB"];let r=e,n=0;for(;r>=1024&&n<t.length-1;)r/=1024,n+=1;return`${r>=10||0===n?Math.round(r):r.toFixed(1)} ${t[n]}`}function C(e){const t=e.querySelector("#home-occupants"),r=e.querySelector("#home-square-footage"),n=e.querySelector("#home-stories"),o=e.querySelector("#home-bathrooms"),a={occupants:t?.value||null,squareFootage:r?.value||null,stories:n?.value||null,bathrooms:o?.value||null},s=[];return a.occupants&&s.push(`Occupants: ${a.occupants}`),a.squareFootage&&s.push(`Square footage: ${a.squareFootage}`),a.stories&&s.push(`Stories: ${a.stories}`),a.bathrooms&&s.push(`Full bathrooms: ${a.bathrooms}`),{summary:s,detail:a}}async function z(e){const t=e.querySelector("textarea"),r=e.querySelector('input[type="file"]'),n=t?.value?.trim()||"",o=r?.files?.[0]||null,a=[],i={};n&&(a.push(`Lab notes: ${n}`),i.notes=n);let l=null;if(o&&o.size<=s){const e=await function(e){return new Promise((t,r)=>{const n=new FileReader;n.onerror=()=>{n.abort(),r(new Error("Unable to read the selected file."))},n.onload=()=>{const e=n.result;if("string"==typeof e){const r=e.includes(",")?e.split(",")[1]:e;t(r)}else r(new Error("Unsupported file format."))},n.readAsDataURL(e)})}(o);l={name:o.name,size:o.size,type:o.type||"application/octet-stream",lastModified:o.lastModified,encoding:"base64",content:e},a.push(`Lab file uploaded: ${o.name} (${x(o.size)})`),i.file=l}return{summary:a,detail:Object.keys(i).length?i:null}}function A(e){const t=e.querySelector("#client-name"),r=e.querySelector("#client-phone"),n=e.querySelector("#client-email"),o=e.querySelector("#client-address"),a={name:t?.value?.trim()||"",phone:r?.value?.trim()||"",email:n?.value?.trim()||"",address:o?.value?.trim()||""},s=[];return a.name&&s.push(`Name: ${a.name}`),a.phone&&s.push(`Phone: ${a.phone}`),a.email&&s.push(`Email: ${a.email}`),a.address&&s.push(`Address: ${a.address}`),{summary:s,detail:a}}function $(e){if(!e)return null;try{const t=JSON.parse(e);return"string"==typeof t?$(t):t}catch(e){return null}}function L(e){const t=[],r=new Set,n=new WeakSet,o=(e,a={})=>{if(!e)return;if(Array.isArray(e))return void e.forEach(e=>o(e,a));if("object"!=typeof e)return;if(n.has(e))return;n.add(e);let s=a;if("string"==typeof e.explanation){const t=e.explanation.trim();t&&(s={...a,explanation:t})}let i=!1;Array.isArray(e.edges)&&(i=!0,e.edges.forEach(e=>o(e,s))),e.node&&(i=!0,o(e.node,s));for(const[t,r]of Object.entries(e))null!=r&&"edges"!==t&&"node"!==t&&(Array.isArray(r)||"object"==typeof r&&r!==e)&&(i=!0,o(r,s));i&&!e.id||((e,n={})=>{const o=function(e,t={}){if(!e||"object"!=typeof e)return null;const r=e.product&&"object"==typeof e.product?e.product:e;if(!r||"object"!=typeof r)return null;const n=String(r.id||"").trim();if(!n||!n.includes("/Product/"))return null;const o=window.Shopify&&window.Shopify.routes&&window.Shopify.routes.root||"/",a=[];Array.isArray(r.variants?.edges)&&r.variants.edges.forEach(e=>{e?.node&&"object"==typeof e.node&&a.push(e.node)}),Array.isArray(r.variants?.nodes)&&r.variants.nodes.forEach(e=>{e&&"object"==typeof e&&a.push(e)});const s=a.find(e=>e?.availableForSale)||a[0]||null;let i=null,l=r.title||"";if(r.featuredImage?.url)i=r.featuredImage.url,l=r.featuredImage.altText||l;else if(Array.isArray(r.images?.edges)){const e=r.images.edges.find(e=>e?.node);e?.node&&(i=e.node.originalSrc||e.node.url||e.node.src||i,l=e.node.altText||l)}else if(Array.isArray(r.images?.nodes)){const e=r.images.nodes.find(Boolean);e&&(i=e.originalSrc||e.url||e.src||i,l=e.altText||l)}const c=t?.explanation||e.explanation||r.explanation||r.description||r.descriptionHtml||"",u="string"==typeof c?c.trim():"",d=s?.price?.amount??s?.price??r.priceRange?.minVariantPrice?.amount??null,p=s?.price?.currencyCode||s?.currencyCode||r.priceRange?.minVariantPrice?.currencyCode||"USD",m=r.handle?String(r.handle).trim():"",h=r.onlineStoreUrl||(m?`${o}products/${m}`:null);return{id:n,handle:m||null,title:r.title||"Recommended product",url:h,image:i,imageAlt:l||r.title||"Recommended product image",price:d,currency:p,variantId:s?.id||null,variants:a,explanation:u}}(e,n);o&&!r.has(o.id)&&(r.add(o.id),t.push(o))})(e,s)};return o(e,{}),t}function E(t,r={}){if(y&&m){if(e.classList.add("quiz-has-results"),q(""),f&&(f.hidden=!0),y.innerHTML="",m.hidden=!1,h&&(r.summary?(h.innerHTML=r.summary,h.hidden=!1):(h.hidden=!0,h.innerHTML="")),!t.length){const e=document.createElement("div");return e.className="error"===r.type?"quiz-results-error":"quiz-results-empty",e.innerHTML="error"===r.type?`<strong>We hit a snag.</strong> ${r.message||"Please refresh and try again, or contact support if it keeps happening."}`:`<strong>We couldn't load your recommendations.</strong> ${r.message||"Please try again in a moment."}`,y.appendChild(e),void m.scrollIntoView({behavior:"smooth",block:"start"})}t.forEach(e=>{const t=document.createElement("article");if(t.className="quiz-card",e.image){const r=document.createElement("img");r.className="quiz-card-image",r.src=e.image,r.alt=e.imageAlt||e.title,r.loading="lazy",t.appendChild(r)}const r=document.createElement("div");r.className="quiz-card-body";const n=document.createElement("h3");if(n.className="quiz-card-title",n.textContent=e.title||"Recommended product",r.appendChild(n),e.explanation){const t=document.createElement("p");t.className="quiz-card-explanation",t.textContent=e.explanation,r.appendChild(t)}if(e.price){const t=document.createElement("p");t.className="quiz-card-price",t.textContent=function(e,t){if(!e)return"";const r=Number(e);if(!Number.isFinite(r))return"";try{return new Intl.NumberFormat(void 0,{style:"currency",currency:t||"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(r)}catch(e){return`${t||"USD"} ${r.toFixed(2)}`}}(e.price,e.currency),r.appendChild(t)}const o=document.createElement("div");o.className="quiz-card-actions";const a=document.createElement("button");if(a.type="button",a.className="quiz-card-button primary",a.textContent=e.variantId?"Add to cart":"See product options",a.disabled=!e.variantId,a.dataset.variantId=e.variantId||"",a.dataset.productTitle=e.title||"",a.addEventListener("click",()=>async function(e){const t=e.dataset.variantId;if(!t)return;const r=t.split("/").pop();if(!r)return;e.disabled=!0;const n=e.textContent;e.textContent="Adding...",q("");try{const t=window.Shopify&&window.Shopify.routes&&window.Shopify.routes.root||"/",o=await fetch(`${t}cart/add.js`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({items:[{id:r,quantity:1}]})});if(!o.ok)throw new Error(`Cart API returned ${o.status}`);q(`✅ ${e.dataset.productTitle||"product"} was added to your cart.`),e.textContent="Added!",setTimeout(()=>{e.textContent=n,e.disabled=!1},2e3)}catch(t){console.error("Add to cart failed:",t),q("We couldn't add this item to your cart. Please try again."),e.textContent=n,e.disabled=!1}}(a)),o.appendChild(a),e.url){const t=document.createElement("a");t.href=e.url,t.className="quiz-card-button secondary",t.textContent="View details",t.target="_blank",t.rel="noopener noreferrer",o.appendChild(t)}r.appendChild(o),t.appendChild(r),y.appendChild(t)}),m.scrollIntoView({behavior:"smooth",block:"start"})}}d&&(d.textContent=a),i&&i.addEventListener("click",()=>{if(v(g)){if(0===g){const e=o[0]?.querySelector('input[type="radio"]:checked');if(e&&"parts"===e.value)return void function(){const e=e=>{e&&q(e),a>1&&S(Math.min(g+1,a-1))};fetch(r,{method:"HEAD"}).then(t=>{t.ok?window.location.href=r:e("Parts and filters page not found. Let's continue with the quiz to find the right system for you.")}).catch(t=>{console.error("Error checking parts page:",t),e("Unable to access parts page. Let's continue with the quiz to find the right system for you.")})}()}if(a){const e=Math.min(g+1,a-1);e!==g&&(S(e),q(""))}}}),l&&l.addEventListener("click",()=>{if(!a)return;const e=Math.max(g-1,0);e!==g&&(S(e),q(""))}),n&&n.addEventListener("submit",async e=>{if(e.preventDefault(),!v(g))return;let r;try{r=await async function(){const e=[];let t=null,r=null,n=null;for(const a of o){const o=a.dataset.type,s={step:Number(a.dataset.step),question:a.dataset.question};if("household"===o){const r=C(a);e.push({...s,answers:r.summary}),t=r.detail;continue}if("lab"===o){const t=await z(a);e.push({...s,answers:t.summary}),t.detail&&(r=t.detail);continue}if("contact"===o){const t=A(a);e.push({...s,answers:t.summary}),n=t.detail;continue}e.push({...s,answers:w(a)})}return{quizName:"AQUALIVIA Perfect Water System Finder",submittedAt:(new Date).toISOString(),answers:e,household:t,lab:r,contact:n}}()}catch(e){return console.error("Failed to prepare submission payload:",e),void q("We could not prepare your submission. Please check your lab file and try again.")}q("Building your personalized recommendation..."),c&&(c.disabled=!0),l&&(l.disabled=!0),i&&(i.disabled=!0),f&&(f.hidden=!1);try{const e=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),n=await e.text();if(!e.ok)throw new Error(`Server responded with ${e.status}: ${n}`);const o=$(n),a=L(o),s=await async function(e=[],t={}){const r=[];t.reasoning&&r.push(`<p>${t.reasoning}</p>`);const n=[],o=new Set;if(e.forEach(e=>{if(!e||!e.title)return;const t=e.title||"Recommended product";if(!o.has(t)){o.add(t);const r=e.explanation||"This system addresses your specific water goals.";n.push(`<li><strong>${t}:</strong> ${r}</li>`)}}),t.insights&&Array.isArray(t.insights)&&t.insights.length){const e=t.insights.map(e=>e?"string"==typeof e?`<li>${e}</li>`:e.title&&e.detail?`<li><strong>${e.title}:</strong> ${e.detail}</li>`:null:null).filter(Boolean);e.length&&(r.push("<h3>What we considered</h3>"),r.push("<ul>"),r.push(e.join("")),r.push("</ul>"))}return n.length&&(r.push("<h3>Why we chose these systems</h3>"),r.push("<ul>"),r.push(n.join("")),r.push("</ul>")),r.length?r.join(""):""}(a,o?.summary??{});a.length?E(a,{summary:s}):E([],{type:"error",message:"The recommendation service returned no product IDs. Please try again soon."})}catch(e){return console.error(e),q("Something went wrong while sending your answers. Please try again."),c&&(c.disabled=!1),l&&(l.disabled=g<=0),i&&(i.disabled=!1),void(f&&(f.hidden=!0))}c&&(c.disabled=!1),l&&(l.disabled=!0),i&&(i.disabled=!0),n.classList.add("quiz-complete"),f&&(f.hidden=!0)}),S(0)}();</script>
  </script>