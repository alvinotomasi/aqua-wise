<div class="aqualivia-quiz" data-api-endpoint="https://primary-production-dae8.up.railway.app/webhook/quiz" data-storefront-token="0932f96dbb3d1ce17ecb1d1816adf97e">
    <h2 class="quiz-section-title">Quiz</h2>
    <form class="quiz-form" novalidate>
      <header class="quiz-header">
        <h1>Design Your AQUALIVIA Water Solution</h1>
        <p>Answer a few practical questions about your home so we can match you with systems that deliver the results you care about most.</p>
        <div class="quiz-progress" role="status" aria-live="polite">
          Step <span class="current-step">1</span> of <span class="total-steps">8</span>
        </div>
      </header>
  
      <section class="quiz-step is-active" data-step="1" data-type="radio" data-question="What is your home's water source?">
        <h2>Question 1: What is your home's water source?</h2>
        <p class="quiz-help">Help us understand the baseline for your water quality.</p>
        <label class="quiz-option">
          <input type="radio" name="q1" value="city" data-answer="City / Municipal Water" required>
          <span>
            <strong>City / Municipal Water</strong>
            <span class="quiz-option-meta">Homes connected to public utilities.</span>
          </span>
        </label>
        <label class="quiz-option">
          <input type="radio" name="q1" value="well" data-answer="Private Well Water">
          <span>
            <strong>Private Well Water</strong>
            <span class="quiz-option-meta">Independent wells with unique treatment needs.</span>
          </span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>

      <section class="quiz-step" data-step="2" data-type="radio" data-question="How many people live in your home?">
        <h2>Question 2: How many people live in your home?</h2>
        <p class="quiz-help">We use this to size equipment for peak daily demand.</p>
        <label class="quiz-option">
          <input type="radio" name="q2" value="1" data-answer="Household size: 1 person (≈1,000 sq ft · 1 story · 1 bath)">
          <span>
            <strong>1 person</strong>
            <span class="quiz-option-meta">Up to ~1,000 sq ft · 1 story · 1 bath</span>
          </span>
        </label>
        <label class="quiz-option">
          <input type="radio" name="q2" value="1-2" data-answer="Household size: 1-2 people (≈1,500 sq ft · 1-2 stories · 1-2 baths)">
          <span>
            <strong>1-2 people</strong>
            <span class="quiz-option-meta">Up to ~1,500 sq ft · 1-2 stories · 1-2 baths</span>
          </span>
        </label>
        <label class="quiz-option">
          <input type="radio" name="q2" value="2-3" data-answer="Household size: 2-3 people (≈2,200 sq ft · 1-2 stories · 2 baths)">
          <span>
            <strong>2-3 people</strong>
            <span class="quiz-option-meta">Up to ~2,200 sq ft · 1-2 stories · 2 baths</span>
          </span>
        </label>
        <label class="quiz-option">
          <input type="radio" name="q2" value="4-6" data-answer="Household size: 4-6 people (≈3,600 sq ft · 2 stories · 2-3 baths)">
          <span>
            <strong>4-6 people</strong>
            <span class="quiz-option-meta">Up to ~3,600 sq ft · 2 stories · 2-3 baths</span>
          </span>
        </label>
        <label class="quiz-option">
          <input type="radio" name="q2" value="6-8" data-answer="Household size: 6-8 people (≈5,200 sq ft · 2-3 stories · 3-4 baths)">
          <span>
            <strong>6-8 people</strong>
            <span class="quiz-option-meta">Up to ~5,200 sq ft · 2-3 stories · 3-4 baths</span>
          </span>
        </label>
        <label class="quiz-option">
          <input type="radio" name="q2" value="8-plus" data-answer="Household size: 8+ people (≈6,500+ sq ft · 3 stories · 4-5 baths)">
          <span>
            <strong>8+ people</strong>
            <span class="quiz-option-meta">Up to ~6,500+ sq ft · 3 stories · 4-5 baths</span>
          </span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>

      <section class="quiz-step" data-step="3" data-type="checkbox" data-question="What water problems have you noticed?">
        <h2>Question 3: What water problems have you noticed? (Check all that apply)</h2>
        <p class="quiz-help">Select every issue you want to fix so we can target the right treatment.</p>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="hardness" data-answer="Hardness issues (scale, soap scum, dry skin)">
          <span>
            <strong>Hardness issues (scale, soap scum, dry skin)</strong>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="odors-tastes" data-answer="Odors and tastes (sulfur, chlorine, metallic, musty)">
          <span>
            <strong>Odors and tastes (sulfur, chlorine, metallic, musty)</strong>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="staining" data-answer="Staining or discoloration (iron, manganese, copper)">
          <span>
            <strong>Staining or discoloration (iron, manganese, copper)</strong>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="cloudiness" data-answer="Cloudiness or sediment">
          <span>
            <strong>Cloudiness or sediment</strong>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="health" data-answer="Health concerns (PFAS, lead, bacteria)">
          <span>
            <strong>Health concerns (PFAS, lead, bacteria)</strong>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="upgrade" data-answer="No specific issues, I just want the best water">
          <span>
            <strong>No specific issues, I just want the best water</strong>
          </span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>

      <section class="quiz-step" data-step="4" data-type="checkbox" data-question="Where do you want to improve your water?">
        <h2>Question 4: Where do you want to improve your water? (Check all that apply)</h2>
        <p class="quiz-help">Tell us which parts of your home need attention.</p>
        <label class="quiz-option">
          <input type="checkbox" name="q4" value="whole-home" data-answer="The Entire Home: Improve water at every faucet, shower, and appliance.">
          <span>
            <strong>The Entire Home</strong>
            <span class="quiz-option-meta">Improve water at every faucet, shower, and appliance.</span>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q4" value="drinking" data-answer="Drinking &amp; Cooking Water: Focus on high-purity water, typically at the kitchen sink.">
          <span>
            <strong>Drinking &amp; Cooking Water</strong>
            <span class="quiz-option-meta">Focus on high-purity water, typically at the kitchen sink.</span>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q4" value="pfas" data-answer="Extra protection for PFAS and lead">
          <span>
            <strong>Extra protection for PFAS and lead</strong>
            <span class="quiz-option-meta">Add specialized filtration for emerging contaminants.</span>
          </span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>

      <section class="quiz-step" data-step="5" data-type="checkbox" data-question="Are you interested in any of these specific features?">
        <h2>Question 5: Are you interested in any of these specific features? (Check all that apply)</h2>
        <p class="quiz-help">Flag any preferences so we can highlight systems with those benefits.</p>
        <label class="quiz-option">
          <input type="checkbox" name="q5" value="salt-free" data-answer="A salt-free system to prevent scale without using salt.">
          <span>
            <strong>A salt-free system to prevent scale without using salt.</strong>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q5" value="chemical-free" data-answer="Chemical-free disinfection to treat for bacteria and viruses.">
          <span>
            <strong>Chemical-free disinfection to treat for bacteria and viruses.</strong>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q5" value="minerals" data-answer="Adding healthy minerals or making my drinking water alkaline.">
          <span>
            <strong>Adding healthy minerals or making my drinking water alkaline.</strong>
          </span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q5" value="no-preference" data-answer="No preference, just recommend the best solution for my issues.">
          <span>
            <strong>No preference, just recommend the best solution for my issues.</strong>
          </span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>

      <section class="quiz-step" data-step="6" data-type="lab" data-question="Lab results (optional)">
        <h2>Step 6: Lab results (optional)</h2>
        <p class="quiz-help">If you have a recent water test, you can upload it or paste your key numbers. This helps us fine-tune your recommendation.</p>

        <div class="quiz-note" role="note">
          <strong>Tip:</strong>
          <span>If you already have a softener, include that in your notes so we don’t suggest a duplicate system.</span>
        </div>

        <div class="quiz-field-group">
          <label class="quiz-field-label" for="lab-file">Upload lab file (PDF or TXT)</label>
          <input class="quiz-file-input" type="file" id="lab-file" name="lab-file" accept=".pdf,.txt,.csv">
          <p class="quiz-field-help">TXT files are read automatically. PDFs are saved with your responses; for faster processing, paste key values below as well.</p>
        </div>

        <div class="quiz-field-group">
          <label class="quiz-field-label" for="lab-values">Or paste lab values</label>
          <textarea class="quiz-textarea" id="lab-values" name="lab-values" placeholder="Example: Hardness 12 gpg, Iron 0.5 mg/L, Manganese 0.06 mg/L, Turbidity 0.3 NTU, pH 7.4, PFAS detected."></textarea>
        </div>

        <p class="quiz-error" aria-live="polite"></p>
      </section>

      <section class="quiz-step" data-step="7" data-type="contact" data-question="Client details">
        <h2>Question 7: Client details</h2>
        <p class="quiz-help">Share the best way to reach you so we can deliver your personalized water system plan.</p>

        <div class="quiz-field-grid">
          <div class="quiz-field-group">
            <label class="quiz-field-label" for="client-name">Full name</label>
            <input class="quiz-input" type="text" id="client-name" name="client-name" autocomplete="name" placeholder="Jane Doe" required>
          </div>

          <div class="quiz-field-group">
            <label class="quiz-field-label" for="client-phone">Phone</label>
            <input class="quiz-input" type="tel" id="client-phone" name="client-phone" autocomplete="tel" placeholder="(555) 123-4567" required>
          </div>

          <div class="quiz-field-group">
            <label class="quiz-field-label" for="client-email">Email</label>
            <input class="quiz-input" type="email" id="client-email" name="client-email" autocomplete="email" placeholder="you@example.com" required>
          </div>

          <div class="quiz-field-group quiz-field-group-full">
            <label class="quiz-field-label" for="client-address">Address</label>
            <textarea class="quiz-textarea" id="client-address" name="client-address" autocomplete="street-address" placeholder="Street, City, State, ZIP" required></textarea>
          </div>
        </div>

        <p class="quiz-error" aria-live="polite"></p>
      </section>
  
      <footer class="quiz-footer">
        <button type="button" class="quiz-button quiz-prev" aria-label="Go to previous question" disabled>Back</button>
        <button type="button" class="quiz-button quiz-next" aria-label="Go to next question">Next</button>
        <button type="submit" class="quiz-button quiz-submit" aria-label="Submit quiz">See My Recommendation</button>
      </footer>
      <p class="quiz-status" aria-live="polite"></p>
    </form>
  
    <section class="quiz-results" hidden>
      <h2>Your Personalized System Picks</h2>
      <p class="quiz-results-help">We matched these products to the challenges you highlighted. Add one to your cart instantly or open the product page for more detail.</p>
      <div class="quiz-results-grid"></div>
    </section>
  </div>
  
  <style>
    .aqualivia-quiz {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      color: #1d2939;
      background: #f7fafc;
      border-radius: 16px;
      padding: 32px;
      max-width: 720px;
      margin: 0 auto;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
    }
  
    @media (max-width: 640px) {
      .aqualivia-quiz {
        padding: 20px;
      }
    }
  
    .quiz-section-title {
      margin: 0 0 24px;
      font-size: 32px;
      font-weight: 700;
      color: #1d2939;
      text-align: center;
    }
  
    @media (max-width: 640px) {
      .quiz-section-title {
        font-size: 28px;
        margin-bottom: 20px;
      }
    }
  
    .quiz-header h1 {
      margin: 0 0 8px;
      font-size: 28px;
      font-weight: 700;
    }
  
    .quiz-header p {
      margin: 0 0 16px;
      line-height: 1.5;
    }
  
    .quiz-progress {
      font-size: 15px;
      font-weight: 600;
      color: #2563eb;
    }
  
    .quiz-step {
      display: none;
      margin-top: 28px;
    }
  
    .quiz-step.is-active {
      display: block;
    }
  
    .quiz-step h2 {
      margin: 0 0 8px;
      font-size: 22px;
      font-weight: 700;
    }
  
    .quiz-help {
      margin: 0 0 18px;
      font-size: 15px;
      color: #475467;
    }
  
    .quiz-option {
      display: block;
      margin-bottom: 12px;
      padding: 16px;
      border: 1px solid #d0d5dd;
      border-radius: 12px;
      background: #fff;
      position: relative;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
  
    .quiz-option input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
  
    .quiz-option span {
      display: block;
      font-size: 16px;
      line-height: 1.4;
    }

    .quiz-option strong {
      display: block;
      font-weight: 600;
      color: #1d2939;
    }

    .quiz-option-meta {
      display: block;
      margin-top: 4px;
      font-size: 14px;
      color: #475467;
    }

    .quiz-note {
      margin: 0 0 20px;
      padding: 14px 16px;
      border-radius: 12px;
      background: #eff6ff;
      border-left: 4px solid #2563eb;
      color: #1d4ed8;
      font-size: 14px;
      line-height: 1.5;
    }

    .quiz-note strong {
      color: #1d4ed8;
      margin-bottom: 4px;
    }

    .quiz-field-group {
      margin-bottom: 20px;
    }

    .quiz-field-grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .quiz-field-group-full {
      grid-column: 1 / -1;
    }

    .quiz-field-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1d2939;
    }

    .quiz-field-help {
      margin: 6px 0 0;
      font-size: 13px;
      color: #475467;
      line-height: 1.4;
    }

    .quiz-input {
      display: block;
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #d0d5dd;
      font-size: 15px;
      color: #1d2939;
      background: #fff;
    }

    .quiz-input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    .quiz-file-input {
      display: block;
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d0d5dd;
      background: #fff;
      font-size: 15px;
    }

    .quiz-file-input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    .quiz-textarea {
      width: 100%;
      min-height: 140px;
      resize: vertical;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid #d0d5dd;
      font-size: 15px;
      line-height: 1.5;
      color: #1d2939;
      background: #fff;
    }

    .quiz-textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }
  
    .quiz-option:hover,
    .quiz-option:focus-within {
      border-color: #2563eb;
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.12);
    }
  
    .quiz-option input:checked + span {
      font-weight: 600;
      color: #1d4ed8;
    }
  
    .quiz-error {
      min-height: 20px;
      font-size: 14px;
      color: #dc2626;
      margin-top: 8px;
    }
  
    .has-error .quiz-option {
      border-color: #dc2626;
    }
  
    .quiz-footer {
      margin-top: 32px;
      display: flex;
      gap: 12px;
    }
  
    .quiz-button {
      flex: 1;
      border: none;
      border-radius: 12px;
      padding: 14px 18px;
      font-size: 16px;
      font-weight: 600;
      background: #2563eb;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }
  
    .quiz-button[disabled] {
      background: #cbd5f5;
      cursor: not-allowed;
      transform: none;
    }
  
    .quiz-button.quiz-prev {
      background: #e0e7ff;
      color: #1d4ed8;
      flex: 0 0 120px;
    }
  
    .quiz-button:hover:not([disabled]) {
      background: #1d4ed8;
      transform: translateY(-1px);
    }
  
    .quiz-button.quiz-prev:hover:not([disabled]) {
      background: #c3d4ff;
    }
  
    .quiz-submit {
      display: none;
    }
  
    .quiz-submit.is-visible {
      display: block;
    }
  
    .quiz-status {
      margin-top: 18px;
      font-size: 15px;
      color: #1d2939;
    }
  
    .quiz-results {
      margin-top: 40px;
      padding-top: 24px;
      border-top: 1px solid #e2e8f0;
    }
  
    .quiz-results h2 {
      margin: 0 0 8px;
      font-size: 24px;
      font-weight: 700;
      color: #111827;
    }
  
    .quiz-results-help {
      margin: 0 0 24px;
      color: #475467;
      font-size: 15px;
    }
  
    .quiz-results-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
  
    .quiz-card {
      background: #fff;
      border-radius: 14px;
      border: 1px solid #d0d5dd;
      box-shadow: 0 14px 28px rgba(15, 23, 42, 0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
  
    .quiz-card-image {
      width: 100%;
      aspect-ratio: 4 / 3;
      object-fit: contain;
      background: #f8fafc;
    }
  
    .quiz-card-body {
      padding: 18px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
  
    .quiz-card-title {
      margin: 0 0 8px;
      font-size: 18px;
      font-weight: 600;
      color: #1d2939;
    }
  
    .quiz-card-explanation {
      margin: 0 0 12px;
      font-size: 14px;
      line-height: 1.5;
      color: #475467;
      font-style: italic;
    }
  
    .quiz-card-price {
      font-size: 16px;
      font-weight: 600;
      color: #2563eb;
      margin-bottom: 12px;
    }
  
    .quiz-card-actions {
      margin-top: auto;
      display: flex;
      gap: 10px;
    }
  
    .quiz-card-button {
      flex: 1;
      border: none;
      border-radius: 10px;
      padding: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease, color 0.2s ease;
    }
  
    .quiz-card-button.primary {
      background: #2563eb;
      color: #fff;
    }
  
    .quiz-card-button.primary:hover:not([disabled]) {
      background: #1d4ed8;
      transform: translateY(-1px);
    }
  
    .quiz-card-button.secondary {
      background: #e0e7ff;
      color: #1d4ed8;
    }
  
    .quiz-card-button.secondary:hover {
      background: #c3d4ff;
      transform: translateY(-1px);
    }
  
    .quiz-card-button[disabled] {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
  
    .quiz-results-empty,
    .quiz-results-error {
      grid-column: 1 / -1;
      padding: 18px;
      border-radius: 12px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
    }
  
    .quiz-results-empty strong {
      display: block;
      margin-bottom: 4px;
    }
  
    .quiz-has-results .quiz-form,
    .quiz-has-results .quiz-status {
      display: none;
    }
  </style>
  
  <script>
    (function () {
      const quiz = document.querySelector('.aqualivia-quiz');
      if (!quiz) return;
  
      const ENDPOINT = quiz.dataset.apiEndpoint;
      const PARTS_PAGE_URL = quiz.dataset.partsUrl || '/collections/parts-and-filters';
  
      const form = quiz.querySelector('.quiz-form');
      const steps = Array.from(quiz.querySelectorAll('.quiz-step'));
      const totalSteps = steps.length;
      const LAB_FILE_SIZE_LIMIT = 5 * 1024 * 1024; // 5 MB
  
      const nextBtn = quiz.querySelector('.quiz-next');
      const prevBtn = quiz.querySelector('.quiz-prev');
      const submitBtn = quiz.querySelector('.quiz-submit');
      const progressCurrent = quiz.querySelector('.current-step');
      const progressTotal = quiz.querySelector('.total-steps');
      const status = quiz.querySelector('.quiz-status');
      const resultsSection = quiz.querySelector('.quiz-results');
      const resultsGrid = quiz.querySelector('.quiz-results-grid');
  
      let currentStep = 0;
  
      if (progressTotal) {
        progressTotal.textContent = totalSteps;
      }
  
      function safeSetStatus(message) {
        if (status) {
          status.textContent = message;
        }
      }
  
      function updateButtons() {
        if (prevBtn) {
          prevBtn.disabled = currentStep <= 0;
        }
  
        const onLastStep = totalSteps > 0 ? currentStep >= totalSteps - 1 : true;
  
        if (nextBtn) {
          nextBtn.style.display = onLastStep ? 'none' : 'block';
        }
  
        if (submitBtn) {
          submitBtn.classList.toggle('is-visible', onLastStep);
        }
  
        if (progressCurrent) {
          const displayStep = totalSteps > 0 ? Math.min(currentStep + 1, totalSteps) : 0;
          progressCurrent.textContent = displayStep;
        }
      }
  
      function showStep(index) {
        if (!totalSteps) {
          currentStep = 0;
          updateButtons();
          return;
        }
  
        const clampedIndex = Math.max(0, Math.min(index, totalSteps - 1));
  
        steps.forEach((step, i) => {
          step.classList.toggle('is-active', i === clampedIndex);
          step.classList.remove('has-error');
          const errorEl = step.querySelector('.quiz-error');
          if (errorEl) errorEl.textContent = '';
        });
  
        currentStep = clampedIndex;
        updateButtons();
      }
  
      function getCheckedAnswers(step) {
        if (!step) return [];
        const type = step.dataset.type;
        const fileInput = step.querySelector('input[type="file"]');
        if (fileInput) {
          const file = fileInput.files?.[0];
          if (file && file.size > LAB_FILE_SIZE_LIMIT) {
            return false;
          }
        }
        if (type === 'checkbox') {
          return Array.from(step.querySelectorAll('input[type="checkbox"]:checked')).map((input) => input.dataset.answer);
        }
        const selected = step.querySelector('input[type="radio"]:checked');
        return selected ? [selected.dataset.answer] : [];
      }
  
      function validateStep(stepIndex) {
        const step = steps[stepIndex];
        if (!step) return true;
  
        const errorEl = step.querySelector('.quiz-error');
        const answers = getCheckedAnswers(step);
        const type = step.dataset.type;
  
        if (type === 'lab') {
          const fileInput = step.querySelector('input[type="file"]');
          const file = fileInput?.files?.[0];

          if (file && file.size > LAB_FILE_SIZE_LIMIT) {
            step.classList.add('has-error');
            if (errorEl) errorEl.textContent = `Please upload a file smaller than ${formatFileSize(LAB_FILE_SIZE_LIMIT)}.`;
            return false;
          }

          step.classList.remove('has-error');
          if (errorEl) errorEl.textContent = '';
          return true;
        }

        if (type === 'contact') {
          const nameInput = step.querySelector('#client-name');
          const phoneInput = step.querySelector('#client-phone');
          const emailInput = step.querySelector('#client-email');
          const addressInput = step.querySelector('#client-address');

          const missingFields = [];
          if (!nameInput?.value.trim()) missingFields.push('name');
          if (!phoneInput?.value.trim()) missingFields.push('phone');
          if (!emailInput?.value.trim()) missingFields.push('email');
          if (!addressInput?.value.trim()) missingFields.push('address');

          if (missingFields.length) {
            step.classList.add('has-error');
            if (errorEl) errorEl.textContent = 'Please complete all contact details so we can follow up with your personalized plan.';
            return false;
          }

          const email = emailInput.value.trim();
          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailPattern.test(email)) {
            step.classList.add('has-error');
            if (errorEl) errorEl.textContent = 'Please enter a valid email address.';
            emailInput.focus();
            return false;
          }

          const phone = phoneInput.value.trim();
          const phoneDigits = phone.replace(/[^0-9]/g, '');
          if (phoneDigits.length < 10) {
            step.classList.add('has-error');
            if (errorEl) errorEl.textContent = 'Please enter a phone number with at least 10 digits.';
            phoneInput.focus();
            return false;
          }

          step.classList.remove('has-error');
          if (errorEl) errorEl.textContent = '';
          return true;
        }

        if (type === 'checkbox' && answers.length === 0) {
          step.classList.add('has-error');
          if (errorEl) errorEl.textContent = 'Please select at least one option.';
          return false;
        }
  
        if (type === 'radio' && answers.length === 0) {
          step.classList.add('has-error');
          if (errorEl) errorEl.textContent = 'Please select one option to continue.';
          return false;
        }
  
        step.classList.remove('has-error');
        if (errorEl) errorEl.textContent = '';
        return true;
      }
  
      function formatFileSize(bytes) {
        if (!Number.isFinite(bytes)) {
          return `${bytes} bytes`;
        }

        const units = ['bytes', 'KB', 'MB', 'GB', 'TB'];
        let value = bytes;
        let unitIndex = 0;

        while (value >= 1024 && unitIndex < units.length - 1) {
          value /= 1024;
          unitIndex += 1;
        }

        const display = value >= 10 || unitIndex === 0 ? Math.round(value) : value.toFixed(1);
        return `${display} ${units[unitIndex]}`;
      }

      function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onerror = () => {
            reader.abort();
            reject(new Error('Unable to read the selected file.'));
          };
          reader.onload = () => {
            const result = reader.result;
            if (typeof result === 'string') {
              const base64 = result.includes(',') ? result.split(',')[1] : result;
              resolve(base64);
            } else {
              reject(new Error('Unsupported file format.'));
            }
          };
          reader.readAsDataURL(file);
        });
      }

      async function collectLabData(step) {
        const textarea = step.querySelector('textarea');
        const fileInput = step.querySelector('input[type="file"]');

        const notes = textarea?.value?.trim() || '';
        const file = fileInput?.files?.[0] || null;

        const summary = [];
        const detail = {};

        if (notes) {
          summary.push(`Lab notes: ${notes}`);
          detail.notes = notes;
        }

        let filePayload = null;

        if (file && file.size <= LAB_FILE_SIZE_LIMIT) {
          const content = await readFileAsBase64(file);
          filePayload = {
            name: file.name,
            size: file.size,
            type: file.type || 'application/octet-stream',
            lastModified: file.lastModified,
            encoding: 'base64',
            content
          };

          summary.push(`Lab file uploaded: ${file.name} (${formatFileSize(file.size)})`);
          detail.file = filePayload;
        }

        return {
          summary,
          detail: Object.keys(detail).length ? detail : null
        };
      }

      function collectContactData(step) {
        const nameInput = step.querySelector('#client-name');
        const phoneInput = step.querySelector('#client-phone');
        const emailInput = step.querySelector('#client-email');
        const addressInput = step.querySelector('#client-address');

        const data = {
          name: nameInput?.value?.trim() || '',
          phone: phoneInput?.value?.trim() || '',
          email: emailInput?.value?.trim() || '',
          address: addressInput?.value?.trim() || ''
        };

        const summary = [];
        if (data.name) summary.push(`Name: ${data.name}`);
        if (data.phone) summary.push(`Phone: ${data.phone}`);
        if (data.email) summary.push(`Email: ${data.email}`);
        if (data.address) summary.push(`Address: ${data.address}`);

        return { summary, detail: data };
      }

      async function gatherPayload() {
        const answers = [];
        let labDetail = null;
        let contactDetail = null;

        for (const step of steps) {
          const type = step.dataset.type;
          const base = {
            step: Number(step.dataset.step),
            question: step.dataset.question
          };

          if (type === 'lab') {
            const labData = await collectLabData(step);
            answers.push({
              ...base,
              answers: labData.summary
            });

            if (labData.detail) {
              labDetail = labData.detail;
            }
            continue;
          }

          if (type === 'contact') {
            const contactData = collectContactData(step);
            answers.push({
              ...base,
              answers: contactData.summary
            });
            contactDetail = contactData.detail;
            continue;
          }

          answers.push({
            ...base,
            answers: getCheckedAnswers(step)
          });
        }

        return {
          quizName: 'AQUALIVIA Perfect Water System Finder',
          submittedAt: new Date().toISOString(),
          answers,
          lab: labDetail,
          contact: contactDetail
        };
      }
  
      function redirectToParts() {
        const proceedToQuiz = (message) => {
          if (message) {
            safeSetStatus(message);
          }
          if (totalSteps > 1) {
            showStep(Math.min(currentStep + 1, totalSteps - 1));
          }
        };
  
        fetch(PARTS_PAGE_URL, { method: 'HEAD' })
          .then((response) => {
            if (response.ok) {
              window.location.href = PARTS_PAGE_URL;
            } else {
              proceedToQuiz('Parts and filters page not found. Let\'s continue with the quiz to find the right system for you.');
            }
          })
          .catch((error) => {
            console.error('Error checking parts page:', error);
            proceedToQuiz('Unable to access parts page. Let\'s continue with the quiz to find the right system for you.');
          });
      }
  
      function safeParseJSON(text) {
        if (!text) return null;
        try {
          const parsed = JSON.parse(text);
          if (typeof parsed === 'string') {
            return safeParseJSON(parsed);
          }
          return parsed;
        } catch (_error) {
          return null;
        }
      }
  
      function transformQuizProduct(rawNode, meta = {}) {
        if (!rawNode || typeof rawNode !== 'object') return null;

        const productNode = rawNode.product && typeof rawNode.product === 'object' ? rawNode.product : rawNode;

        if (!productNode || typeof productNode !== 'object') return null;

        const id = String(productNode.id || '').trim();
        if (!id || !id.includes('/Product/')) return null;

        const storeRoot = (window.Shopify && window.Shopify.routes && window.Shopify.routes.root) || '/';

        const variants = [];
        if (Array.isArray(productNode.variants?.edges)) {
          productNode.variants.edges.forEach((edge) => {
            if (edge?.node && typeof edge.node === 'object') {
              variants.push(edge.node);
            }
          });
        }
        if (Array.isArray(productNode.variants?.nodes)) {
          productNode.variants.nodes.forEach((node) => {
            if (node && typeof node === 'object') {
              variants.push(node);
            }
          });
        }

        const preferredVariant =
          variants.find((variant) => variant?.availableForSale) ||
          variants[0] ||
          null;

        let imageUrl = null;
        let imageAlt = productNode.title || '';

        if (productNode.featuredImage?.url) {
          imageUrl = productNode.featuredImage.url;
          imageAlt = productNode.featuredImage.altText || imageAlt;
        } else if (Array.isArray(productNode.images?.edges)) {
          const firstImage = productNode.images.edges.find((edge) => edge?.node);
          if (firstImage?.node) {
            imageUrl = firstImage.node.originalSrc || firstImage.node.url || firstImage.node.src || imageUrl;
            imageAlt = firstImage.node.altText || imageAlt;
          }
        } else if (Array.isArray(productNode.images?.nodes)) {
          const firstImage = productNode.images.nodes.find(Boolean);
          if (firstImage) {
            imageUrl = firstImage.originalSrc || firstImage.url || firstImage.src || imageUrl;
            imageAlt = firstImage.altText || imageAlt;
          }
        }

        const explanationSource =
          meta?.explanation ||
          rawNode.explanation ||
          productNode.explanation ||
          productNode.description ||
          productNode.descriptionHtml ||
          '';

        const explanation = typeof explanationSource === 'string' ? explanationSource.trim() : '';

        const priceAmount =
          preferredVariant?.price?.amount ??
          preferredVariant?.price ??
          productNode.priceRange?.minVariantPrice?.amount ??
          null;

        const currency =
          preferredVariant?.price?.currencyCode ||
          preferredVariant?.currencyCode ||
          productNode.priceRange?.minVariantPrice?.currencyCode ||
          'USD';

        const handle = productNode.handle ? String(productNode.handle).trim() : '';
        const url = productNode.onlineStoreUrl || (handle ? `${storeRoot}products/${handle}` : null);

        return {
          id,
          handle: handle || null,
          title: productNode.title || 'Recommended product',
          url,
          image: imageUrl,
          imageAlt: imageAlt || productNode.title || 'Recommended product image',
          price: priceAmount,
          currency,
          variantId: preferredVariant?.id || null,
          variants,
          explanation
        };
      }

      function extractProductRecommendations(payload) {
        const products = [];
        const seenIds = new Set();
        const visited = new WeakSet();

        const pushProduct = (candidate, meta = {}) => {
          const product = transformQuizProduct(candidate, meta);
          if (product && !seenIds.has(product.id)) {
            seenIds.add(product.id);
            products.push(product);
          }
        };

        const visit = (item, meta = {}) => {
          if (!item) return;

          if (Array.isArray(item)) {
            item.forEach((entry) => visit(entry, meta));
            return;
          }

          if (typeof item !== 'object') {
            return;
          }

          if (visited.has(item)) {
            return;
          }
          visited.add(item);

          let nextMeta = meta;
          if (typeof item.explanation === 'string') {
            const explanation = item.explanation.trim();
            if (explanation) {
              nextMeta = { ...meta, explanation };
            }
          }

          let forwarded = false;

          if (Array.isArray(item.edges)) {
            forwarded = true;
            item.edges.forEach((edge) => visit(edge, nextMeta));
          }

          if (item.node) {
            forwarded = true;
            visit(item.node, nextMeta);
          }

          for (const [key, value] of Object.entries(item)) {
            if (value === undefined || value === null) continue;
            if (key === 'edges' || key === 'node') continue;
            if (Array.isArray(value) || (typeof value === 'object' && value !== item)) {
              forwarded = true;
              visit(value, nextMeta);
            }
          }

          if (!forwarded || item.id) {
            pushProduct(item, nextMeta);
          }
        };

        visit(payload, {});
        return products;
      }
  
  
      function formatMoney(amount, currency) {
        if (!amount) return '';
        const number = Number(amount);
        if (!Number.isFinite(number)) return '';
        try {
          return new Intl.NumberFormat(undefined, {
            style: 'currency',
            currency: currency || 'USD',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }).format(number);
        } catch (_error) {
          return `${currency || 'USD'} ${number.toFixed(2)}`;
        }
      }
  
      function renderRecommendations(products, options = {}) {
        if (!resultsGrid || !resultsSection) return;
  
        quiz.classList.add('quiz-has-results');
        safeSetStatus('');
  
        resultsGrid.innerHTML = '';
        resultsSection.hidden = false;
  
        if (!products.length) {
          const message = document.createElement('div');
          message.className = options.type === 'error' ? 'quiz-results-error' : 'quiz-results-empty';
          message.innerHTML =
            options.type === 'error'
              ? `<strong>We hit a snag.</strong> ${options.message || 'Please refresh and try again, or contact support if it keeps happening.'}`
              : `<strong>We couldn't load your recommendations.</strong> ${options.message || 'Please try again in a moment.'}`;
          resultsGrid.appendChild(message);
          resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          return;
        }
  
        products.forEach((product) => {
          const card = document.createElement('article');
          card.className = 'quiz-card';
  
          if (product.image) {
            const img = document.createElement('img');
            img.className = 'quiz-card-image';
            img.src = product.image;
            img.alt = product.imageAlt || product.title;
            img.loading = 'lazy';
            card.appendChild(img);
          }
  
          const body = document.createElement('div');
          body.className = 'quiz-card-body';
  
          const title = document.createElement('h3');
          title.className = 'quiz-card-title';
          title.textContent = product.title || 'Recommended product';
          body.appendChild(title);
  
          // Add explanation if available
          if (product.explanation) {
            const explanation = document.createElement('p');
            explanation.className = 'quiz-card-explanation';
            explanation.textContent = product.explanation;
            body.appendChild(explanation);
          }
  
          if (product.price) {
            const price = document.createElement('p');
            price.className = 'quiz-card-price';
            price.textContent = formatMoney(product.price, product.currency);
            body.appendChild(price);
          }
  
          const actions = document.createElement('div');
          actions.className = 'quiz-card-actions';
  
          const addButton = document.createElement('button');
          addButton.type = 'button';
          addButton.className = 'quiz-card-button primary';
          addButton.textContent = product.variantId ? 'Add to cart' : 'See product options';
          addButton.disabled = !product.variantId;
          addButton.dataset.variantId = product.variantId || '';
          addButton.dataset.productTitle = product.title || '';
          addButton.addEventListener('click', () => handleAddToCart(addButton));
          actions.appendChild(addButton);
  
          if (product.url) {
            const linkButton = document.createElement('a');
            linkButton.href = product.url;
            linkButton.className = 'quiz-card-button secondary';
            linkButton.textContent = 'View details';
            linkButton.target = '_blank';
            linkButton.rel = 'noopener noreferrer';
            actions.appendChild(linkButton);
          }
  
          body.appendChild(actions);
          card.appendChild(body);
          resultsGrid.appendChild(card);
        });
  
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
  
      async function handleAddToCart(button) {
        const variantGid = button.dataset.variantId;
        if (!variantGid) return;
  
        const variantIdNumeric = variantGid.split('/').pop();
        if (!variantIdNumeric) return;
  
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = 'Adding...';
        safeSetStatus('');
  
        try {
          const storeRoot = (window.Shopify && window.Shopify.routes && window.Shopify.routes.root) || '/';
          const response = await fetch(`${storeRoot}cart/add.js`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              items: [
                {
                  id: variantIdNumeric,
                  quantity: 1
                }
              ]
            })
          });
  
          if (!response.ok) {
            throw new Error(`Cart API returned ${response.status}`);
          }
  
          const productTitle = button.dataset.productTitle || 'product';
          safeSetStatus(`✅ ${productTitle} was added to your cart.`);
          button.textContent = 'Added!';
          setTimeout(() => {
            button.textContent = originalText;
            button.disabled = false;
          }, 2000);
        } catch (error) {
          console.error('Add to cart failed:', error);
          safeSetStatus('We couldn\'t add this item to your cart. Please try again.');
          button.textContent = originalText;
          button.disabled = false;
        }
      }
  
      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          if (!validateStep(currentStep)) return;
  
          if (currentStep === 0) {
            const choice = steps[0]?.querySelector('input[type="radio"]:checked');
            if (choice && choice.value === 'parts') {
              redirectToParts();
              return;
            }
          }
  
          if (totalSteps) {
            const nextIndex = Math.min(currentStep + 1, totalSteps - 1);
            if (nextIndex !== currentStep) {
              showStep(nextIndex);
              safeSetStatus('');
            }
          }
        });
      }
  
      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          if (!totalSteps) return;
          const prevIndex = Math.max(currentStep - 1, 0);
          if (prevIndex !== currentStep) {
            showStep(prevIndex);
            safeSetStatus('');
          }
        });
      }
  
      if (form) {
        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!validateStep(currentStep)) return;
  
          let payload;

          try {
            payload = await gatherPayload();
          } catch (error) {
            console.error('Failed to prepare submission payload:', error);
            safeSetStatus('We could not prepare your submission. Please check your lab file and try again.');
            return;
          }
  
          safeSetStatus('Building your personalized recommendation...');
          if (submitBtn) submitBtn.disabled = true;
          if (prevBtn) prevBtn.disabled = true;
          if (nextBtn) nextBtn.disabled = true;
  
          try {
            const response = await fetch(ENDPOINT, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload)
            });
  
            const text = await response.text();
            if (!response.ok) {
              throw new Error(`Server responded with ${response.status}: ${text}`);
            }
  
            const parsed = safeParseJSON(text);
            const recommendations = extractProductRecommendations(parsed);

            if (recommendations.length) {
              renderRecommendations(recommendations);
            } else {
              renderRecommendations([], {
                type: 'error',
                message: 'The recommendation service returned no product IDs. Please try again soon.'
              });
            }
          } catch (error) {
            console.error(error);
            safeSetStatus('Something went wrong while sending your answers. Please try again.');
            if (submitBtn) submitBtn.disabled = false;
            if (prevBtn) prevBtn.disabled = currentStep <= 0;
            if (nextBtn) nextBtn.disabled = false;
            return;
          }
  
          if (submitBtn) submitBtn.disabled = false;
          if (prevBtn) prevBtn.disabled = true;
          if (nextBtn) nextBtn.disabled = true;
          form.classList.add('quiz-complete');
        });
      }
  
      showStep(0);
    })();
  </script>
  </script>