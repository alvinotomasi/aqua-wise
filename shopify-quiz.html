<div class="aqualivia-quiz" data-api-endpoint="https://primary-production-dae8.up.railway.app/webhook/quiz" data-parts-url="/collections/parts-and-filters" data-storefront-token="0932f96dbb3d1ce17ecb1d1816adf97e">
    <h2 class="quiz-section-title">Quiz</h2>
    <form class="quiz-form" novalidate>
      <header class="quiz-header">
        <h1>The AQUALIVIA Perfect Water System Finder</h1>
        <p>Don't guess which water system you need. Answer a few key questions, and we'll build a personalized recommendation just for you.</p>
        <div class="quiz-progress" role="status" aria-live="polite">
          Step <span class="current-step">1</span> of <span class="total-steps">8</span>
        </div>
      </header>
  
      <section class="quiz-step is-active" data-step="1" data-type="radio" data-question="What are you looking for today?">
        <h2>Question 1: What are you looking for today?</h2>
        <p class="quiz-help">This helps us direct you to the right place from the start.</p>
        <label class="quiz-option">
          <input type="radio" name="q1" value="new-system" data-answer="I'm looking for a new water treatment system for my home." required>
          <span>I'm looking for a new water treatment system for my home.</span>
        </label>
        <label class="quiz-option">
          <input type="radio" name="q1" value="parts" data-answer="I need replacement filters or parts for a system I already own.">
          <span>I need replacement filters or parts for a system I already own.</span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>
  
      <section class="quiz-step" data-step="2" data-type="radio" data-question="What is your home's water source?">
        <h2>Question 2: What is your home's water source?</h2>
        <p class="quiz-help">City and well water have very different treatment needs.</p>
        <label class="quiz-option">
          <input type="radio" name="q2" value="city" data-answer="City / Municipal Water">
          <span>City / Municipal Water</span>
        </label>
        <label class="quiz-option">
          <input type="radio" name="q2" value="well" data-answer="Private Well Water">
          <span>Private Well Water</span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>
  
      <section class="quiz-step" data-step="3" data-type="checkbox" data-question="What water problems have you noticed?">
        <h2>Question 3: What water problems have you noticed? (Check all that apply)</h2>
        <p class="quiz-help">This is the most important step. Tell us everything you're experiencing.</p>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="hard-water" data-answer="Hard Water Signs">
          <span>Hard Water Signs: White, chalky scale on faucets; spots on glassware; soap scum in showers; dry skin or dull hair.</span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="bad-smells" data-answer="Bad Smells">
          <span>Bad Smells: A "rotten egg," sulfur, or musty odor.</span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="chemical" data-answer="Chemical Tastes/Smells">
          <span>Chemical Tastes/Smells: A distinct chlorine ("swimming pool") taste or other chemical odors.</span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="staining" data-answer="Staining">
          <span>Staining: Orange, red, brown, or black stains in sinks, toilets, or on laundry.</span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="bad-taste" data-answer="Bad Taste">
          <span>Bad Taste: Water has a metallic, earthy, or generally unpleasant taste.</span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="visible" data-answer="Visible Contaminants">
          <span>Visible Contaminants: Water is cloudy, discolored, or you can see particles of sand, silt, or rust.</span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="health" data-answer="Health Concerns">
          <span>Health Concerns: I'm worried about invisible contaminants like bacteria, viruses, lead, or chemicals (PFAS).</span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q3" value="upgrade" data-answer="No specific problems">
          <span>No specific problems, I'm just looking for an upgrade to the best water quality possible.</span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>
  
      <section class="quiz-step" data-step="4" data-type="radio" data-question="Where do you want to improve your water?">
        <h2>Question 4: Where do you want to improve your water?</h2>
        <p class="quiz-help">Are you looking for a whole-house solution or just better water from a specific tap?</p>
        <label class="quiz-option">
          <input type="radio" name="q4" value="whole-home" data-answer="The Entire Home">
          <span>The Entire Home: Improve water at every faucet, shower, and appliance.</span>
        </label>
        <label class="quiz-option">
          <input type="radio" name="q4" value="drinking" data-answer="Drinking &amp; Cooking Water">
          <span>Drinking &amp; Cooking Water: Focus on high-purity water, typically at the kitchen sink.</span>
        </label>
        <label class="quiz-option">
          <input type="radio" name="q4" value="specific" data-answer="A Specific Application">
          <span>A Specific Application: Such as spot-free car washing or water for a commercial business.</span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>
  
      <section class="quiz-step" data-step="5" data-type="radio" data-question="Do you own or rent your home?">
        <h2>Question 5: Do you own or rent your home?</h2>
        <p class="quiz-help">This helps us recommend solutions that are practical for your living situation.</p>
        <label class="quiz-option">
          <input type="radio" name="q5" value="own" data-answer="I own my home.">
          <span>I own my home.</span>
        </label>
        <label class="quiz-option">
          <input type="radio" name="q5" value="rent" data-answer="I rent my home.">
          <span>I rent my home.</span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>
  
      <section class="quiz-step" data-step="6" data-type="radio" data-question="How many people live in your home?">
        <h2>Question 6: How many people live in your home?</h2>
        <p class="quiz-help">This helps us determine the right system capacity for your daily needs.</p>
        <label class="quiz-option">
          <input type="radio" name="q6" value="1-3" data-answer="1-3 People">
          <span>1-3 People</span>
        </label>
        <label class="quiz-option">
          <input type="radio" name="q6" value="4-6" data-answer="4-6 People">
          <span>4-6 People</span>
        </label>
        <label class="quiz-option">
          <input type="radio" name="q6" value="7-plus" data-answer="7+ People">
          <span>7+ People</span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>
  
      <section class="quiz-step" data-step="7" data-type="radio" data-question="How many bathrooms does your home have?">
        <h2>Question 7: How many bathrooms does your home have?</h2>
        <p class="quiz-help">This helps us size a system that can handle peak water usage without a drop in performance.</p>
        <label class="quiz-option">
          <input type="radio" name="q7" value="1-2" data-answer="1-2 Bathrooms">
          <span>1-2 Bathrooms</span>
        </label>
        <label class="quiz-option">
          <input type="radio" name="q7" value="3-4" data-answer="3-4 Bathrooms">
          <span>3-4 Bathrooms</span>
        </label>
        <label class="quiz-option">
          <input type="radio" name="q7" value="5-plus" data-answer="5+ Bathrooms">
          <span>5+ Bathrooms</span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>
  
      <section class="quiz-step" data-step="8" data-type="checkbox" data-question="Are you interested in any of these specific features?">
        <h2>Question 8: Are you interested in any of these specific features?</h2>
        <p class="quiz-help">Let us know if you have a preference for a certain technology.</p>
        <label class="quiz-option">
          <input type="checkbox" name="q8" value="salt-free" data-answer="A salt-free system to prevent scale without using salt.">
          <span>A salt-free system to prevent scale without using salt.</span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q8" value="chemical-free" data-answer="Chemical-free disinfection to treat for bacteria and viruses.">
          <span>Chemical-free disinfection to treat for bacteria and viruses.</span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q8" value="minerals" data-answer="Adding healthy minerals or making my drinking water alkaline.">
          <span>Adding healthy minerals or making my drinking water alkaline.</span>
        </label>
        <label class="quiz-option">
          <input type="checkbox" name="q8" value="no-preference" data-answer="No preference, just recommend the best solution for my issues.">
          <span>No preference, just recommend the best solution for my issues.</span>
        </label>
        <p class="quiz-error" aria-live="polite"></p>
      </section>
  
      <footer class="quiz-footer">
        <button type="button" class="quiz-button quiz-prev" aria-label="Go to previous question" disabled>Back</button>
        <button type="button" class="quiz-button quiz-next" aria-label="Go to next question">Next</button>
        <button type="submit" class="quiz-button quiz-submit" aria-label="Submit quiz">See My Recommendation</button>
      </footer>
      <p class="quiz-status" aria-live="polite"></p>
    </form>
  
    <section class="quiz-results" hidden>
      <h2>Your Personalized System Picks</h2>
      <p class="quiz-results-help">We matched these products to the challenges you highlighted. Add one to your cart instantly or open the product page for more detail.</p>
      <div class="quiz-results-grid"></div>
    </section>
  </div>
  
  <style>
    .aqualivia-quiz {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      color: #1d2939;
      background: #f7fafc;
      border-radius: 16px;
      padding: 32px;
      max-width: 720px;
      margin: 0 auto;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
    }
  
    @media (max-width: 640px) {
      .aqualivia-quiz {
        padding: 20px;
      }
    }
  
    .quiz-section-title {
      margin: 0 0 24px;
      font-size: 32px;
      font-weight: 700;
      color: #1d2939;
      text-align: center;
    }
  
    @media (max-width: 640px) {
      .quiz-section-title {
        font-size: 28px;
        margin-bottom: 20px;
      }
    }
  
    .quiz-header h1 {
      margin: 0 0 8px;
      font-size: 28px;
      font-weight: 700;
    }
  
    .quiz-header p {
      margin: 0 0 16px;
      line-height: 1.5;
    }
  
    .quiz-progress {
      font-size: 15px;
      font-weight: 600;
      color: #2563eb;
    }
  
    .quiz-step {
      display: none;
      margin-top: 28px;
    }
  
    .quiz-step.is-active {
      display: block;
    }
  
    .quiz-step h2 {
      margin: 0 0 8px;
      font-size: 22px;
      font-weight: 700;
    }
  
    .quiz-help {
      margin: 0 0 18px;
      font-size: 15px;
      color: #475467;
    }
  
    .quiz-option {
      display: block;
      margin-bottom: 12px;
      padding: 16px;
      border: 1px solid #d0d5dd;
      border-radius: 12px;
      background: #fff;
      position: relative;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
  
    .quiz-option input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
  
    .quiz-option span {
      display: block;
      font-size: 16px;
      line-height: 1.4;
    }
  
    .quiz-option:hover,
    .quiz-option:focus-within {
      border-color: #2563eb;
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.12);
    }
  
    .quiz-option input:checked + span {
      font-weight: 600;
      color: #1d4ed8;
    }
  
    .quiz-error {
      min-height: 20px;
      font-size: 14px;
      color: #dc2626;
      margin-top: 8px;
    }
  
    .has-error .quiz-option {
      border-color: #dc2626;
    }
  
    .quiz-footer {
      margin-top: 32px;
      display: flex;
      gap: 12px;
    }
  
    .quiz-button {
      flex: 1;
      border: none;
      border-radius: 12px;
      padding: 14px 18px;
      font-size: 16px;
      font-weight: 600;
      background: #2563eb;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }
  
    .quiz-button[disabled] {
      background: #cbd5f5;
      cursor: not-allowed;
      transform: none;
    }
  
    .quiz-button.quiz-prev {
      background: #e0e7ff;
      color: #1d4ed8;
      flex: 0 0 120px;
    }
  
    .quiz-button:hover:not([disabled]) {
      background: #1d4ed8;
      transform: translateY(-1px);
    }
  
    .quiz-button.quiz-prev:hover:not([disabled]) {
      background: #c3d4ff;
    }
  
    .quiz-submit {
      display: none;
    }
  
    .quiz-submit.is-visible {
      display: block;
    }
  
    .quiz-status {
      margin-top: 18px;
      font-size: 15px;
      color: #1d2939;
    }
  
    .quiz-results {
      margin-top: 40px;
      padding-top: 24px;
      border-top: 1px solid #e2e8f0;
    }
  
    .quiz-results h2 {
      margin: 0 0 8px;
      font-size: 24px;
      font-weight: 700;
      color: #111827;
    }
  
    .quiz-results-help {
      margin: 0 0 24px;
      color: #475467;
      font-size: 15px;
    }
  
    .quiz-results-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
  
    .quiz-card {
      background: #fff;
      border-radius: 14px;
      border: 1px solid #d0d5dd;
      box-shadow: 0 14px 28px rgba(15, 23, 42, 0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
  
    .quiz-card-image {
      width: 100%;
      aspect-ratio: 4 / 3;
      object-fit: contain;
      background: #f8fafc;
    }
  
    .quiz-card-body {
      padding: 18px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
  
    .quiz-card-title {
      margin: 0 0 8px;
      font-size: 18px;
      font-weight: 600;
      color: #1d2939;
    }
  
    .quiz-card-explanation {
      margin: 0 0 12px;
      font-size: 14px;
      line-height: 1.5;
      color: #475467;
      font-style: italic;
    }
  
    .quiz-card-price {
      font-size: 16px;
      font-weight: 600;
      color: #2563eb;
      margin-bottom: 12px;
    }
  
    .quiz-card-actions {
      margin-top: auto;
      display: flex;
      gap: 10px;
    }
  
    .quiz-card-button {
      flex: 1;
      border: none;
      border-radius: 10px;
      padding: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease, color 0.2s ease;
    }
  
    .quiz-card-button.primary {
      background: #2563eb;
      color: #fff;
    }
  
    .quiz-card-button.primary:hover:not([disabled]) {
      background: #1d4ed8;
      transform: translateY(-1px);
    }
  
    .quiz-card-button.secondary {
      background: #e0e7ff;
      color: #1d4ed8;
    }
  
    .quiz-card-button.secondary:hover {
      background: #c3d4ff;
      transform: translateY(-1px);
    }
  
    .quiz-card-button[disabled] {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
  
    .quiz-results-empty,
    .quiz-results-error {
      grid-column: 1 / -1;
      padding: 18px;
      border-radius: 12px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
    }
  
    .quiz-results-empty strong {
      display: block;
      margin-bottom: 4px;
    }
  
    .quiz-has-results .quiz-form,
    .quiz-has-results .quiz-status {
      display: none;
    }
  </style>
  
  <script>
    (function () {
      const quiz = document.querySelector('.aqualivia-quiz');
      if (!quiz) return;
  
      const ENDPOINT = quiz.dataset.apiEndpoint;
      const PARTS_PAGE_URL = quiz.dataset.partsUrl || '/collections/parts-and-filters';
      const STOREFRONT_TOKEN_FROM_DATA = quiz.dataset.storefrontToken || '0932f96dbb3d1ce17ecb1d1816adf97e';
  
      const form = quiz.querySelector('.quiz-form');
      const steps = Array.from(quiz.querySelectorAll('.quiz-step'));
      const totalSteps = steps.length;
  
      const nextBtn = quiz.querySelector('.quiz-next');
      const prevBtn = quiz.querySelector('.quiz-prev');
      const submitBtn = quiz.querySelector('.quiz-submit');
      const progressCurrent = quiz.querySelector('.current-step');
      const progressTotal = quiz.querySelector('.total-steps');
      const status = quiz.querySelector('.quiz-status');
      const resultsSection = quiz.querySelector('.quiz-results');
      const resultsGrid = quiz.querySelector('.quiz-results-grid');
  
      let currentStep = 0;
  
      if (progressTotal) {
        progressTotal.textContent = totalSteps;
      }
  
      function safeSetStatus(message) {
        if (status) {
          status.textContent = message;
        }
      }
  
      function updateButtons() {
        if (prevBtn) {
          prevBtn.disabled = currentStep <= 0;
        }
  
        const onLastStep = totalSteps > 0 ? currentStep >= totalSteps - 1 : true;
  
        if (nextBtn) {
          nextBtn.style.display = onLastStep ? 'none' : 'block';
        }
  
        if (submitBtn) {
          submitBtn.classList.toggle('is-visible', onLastStep);
        }
  
        if (progressCurrent) {
          const displayStep = totalSteps > 0 ? Math.min(currentStep + 1, totalSteps) : 0;
          progressCurrent.textContent = displayStep;
        }
      }
  
      function showStep(index) {
        if (!totalSteps) {
          currentStep = 0;
          updateButtons();
          return;
        }
  
        const clampedIndex = Math.max(0, Math.min(index, totalSteps - 1));
  
        steps.forEach((step, i) => {
          step.classList.toggle('is-active', i === clampedIndex);
          step.classList.remove('has-error');
          const errorEl = step.querySelector('.quiz-error');
          if (errorEl) errorEl.textContent = '';
        });
  
        currentStep = clampedIndex;
        updateButtons();
      }
  
      function getCheckedAnswers(step) {
        if (!step) return [];
        const type = step.dataset.type;
        if (type === 'checkbox') {
          return Array.from(step.querySelectorAll('input[type="checkbox"]:checked')).map((input) => input.dataset.answer);
        }
        const selected = step.querySelector('input[type="radio"]:checked');
        return selected ? [selected.dataset.answer] : [];
      }
  
      function validateStep(stepIndex) {
        const step = steps[stepIndex];
        if (!step) return true;
  
        const errorEl = step.querySelector('.quiz-error');
        const answers = getCheckedAnswers(step);
        const type = step.dataset.type;
  
        if (type === 'checkbox' && answers.length === 0) {
          step.classList.add('has-error');
          if (errorEl) errorEl.textContent = 'Please select at least one option.';
          return false;
        }
  
        if (type === 'radio' && answers.length === 0) {
          step.classList.add('has-error');
          if (errorEl) errorEl.textContent = 'Please select one option to continue.';
          return false;
        }
  
        step.classList.remove('has-error');
        if (errorEl) errorEl.textContent = '';
        return true;
      }
  
      function gatherPayload() {
        const answers = steps.map((step) => ({
          step: Number(step.dataset.step),
          question: step.dataset.question,
          answers: getCheckedAnswers(step)
        }));
        return {
          quizName: 'AQUALIVIA Perfect Water System Finder',
          submittedAt: new Date().toISOString(),
          answers
        };
      }
  
      function redirectToParts() {
        const proceedToQuiz = (message) => {
          if (message) {
            safeSetStatus(message);
          }
          if (totalSteps > 1) {
            showStep(Math.min(currentStep + 1, totalSteps - 1));
          }
        };
  
        fetch(PARTS_PAGE_URL, { method: 'HEAD' })
          .then((response) => {
            if (response.ok) {
              window.location.href = PARTS_PAGE_URL;
            } else {
              proceedToQuiz('Parts and filters page not found. Let\'s continue with the quiz to find the right system for you.');
            }
          })
          .catch((error) => {
            console.error('Error checking parts page:', error);
            proceedToQuiz('Unable to access parts page. Let\'s continue with the quiz to find the right system for you.');
          });
      }
  
      function safeParseJSON(text) {
        if (!text) return null;
        try {
          const parsed = JSON.parse(text);
          if (typeof parsed === 'string') {
            return safeParseJSON(parsed);
          }
          return parsed;
        } catch (_error) {
          return null;
        }
      }
  
      function extractProductRecommendations(payload) {
        if (!payload) return [];
        
        // Handle new format: { recommendedProductIds: [{productId, explanation}, ...] }
        if (payload.recommendedProductIds && Array.isArray(payload.recommendedProductIds)) {
          return payload.recommendedProductIds.map(item => ({
            id: String(item.productId || item.id || '').trim(),
            explanation: String(item.explanation || '').trim()
          })).filter(item => item.id);
        }
  
        // Fallback: handle old format with just IDs
        const items = Array.isArray(payload) ? payload : [payload];
        const recommendations = [];
        
        items.forEach((item) => {
          if (!item || typeof item !== 'object') return;
          
          // Check for various possible array field names
          const candidates = item.recommendationProductIds || item.recommendationProudctIds || item.productIds || item.ids;
          
          if (Array.isArray(candidates)) {
            candidates.forEach((candidate) => {
              if (candidate) {
                // If candidate is an object with productId
                if (typeof candidate === 'object' && candidate.productId) {
                  recommendations.push({
                    id: String(candidate.productId).trim(),
                    explanation: String(candidate.explanation || '').trim()
                  });
                } else {
                  // Just an ID string
                  recommendations.push({
                    id: String(candidate).trim(),
                    explanation: ''
                  });
                }
              }
            });
          }
        });
        
        return recommendations;
      }
  
      function findStorefrontToken() {
        const meta =
          document.querySelector('meta[name="storefront-access-token"]') ||
          document.querySelector('meta[name="storefront-token"]') ||
          document.querySelector('meta[name="shopify-x-storefront-access-token"]');
        return (STOREFRONT_TOKEN_FROM_DATA || meta?.getAttribute('content') || '').trim();
      }
  
      // Normalize various incoming recommendation ID formats into
      // Shopify Product and ProductVariant GIDs and/or product handles.
      function normalizeRecommendationIds(recommendations) {
        const productGids = [];
        const variantGids = [];
        const handles = [];
        const explanationMap = new Map();

        const toProductGid = (numericId) => `gid://shopify/Product/${numericId}`;
        const toVariantGid = (numericId) => `gid://shopify/ProductVariant/${numericId}`;

        recommendations.forEach((rec) => {
          const original = String(rec?.id || '').trim();
          const explanation = String(rec?.explanation || '').trim();
          if (!original) return;

          let productGid = null;
          let variantGid = null;
          let handle = null;

          // 1) Direct GID -> keep exact type
          const gidMatch = original.match(/gid:\/\/shopify\/(Product|ProductVariant)\/(\d+)/);
          if (gidMatch) {
            const type = gidMatch[1];
            const idNum = gidMatch[2];
            if (type === 'Product') {
              productGid = toProductGid(idNum);
            } else if (type === 'ProductVariant') {
              variantGid = toVariantGid(idNum);
            }
          }

          // 2) Numeric ID (unknown type) -> try both product and variant
          if (!productGid && !variantGid && /^\d+$/.test(original)) {
            productGid = toProductGid(original);
            variantGid = toVariantGid(original);
          }

          // 3) Product URL -> extract handle
          if (!productGid && !variantGid && original.includes('/products/')) {
            try {
              const url = new URL(original, window.location.origin);
              const m = url.pathname.match(/\/products\/([^\/?#]+)/);
              if (m) handle = decodeURIComponent(m[1]);
            } catch (_e) {
              // Ignore URL parsing failures
            }
          }

          // 4) Slug-like string -> assume handle
          if (!productGid && !variantGid && !handle && /^[a-z0-9-]+$/.test(original)) {
            handle = original;
          }

          if (productGid) {
            productGids.push(productGid);
            if (explanation) explanationMap.set(productGid, explanation);
          }
          if (variantGid) {
            variantGids.push(variantGid);
            if (explanation) explanationMap.set(variantGid, explanation);
          }
          if (handle) {
            handles.push(handle);
            if (explanation) explanationMap.set(handle, explanation);
          }

          // Also keep original mapping for any downstream matching attempts
          if (explanation && !explanationMap.has(original)) {
            explanationMap.set(original, explanation);
          }
        });

        return { productGids, variantGids, handles, explanationMap };
      }

      async function fetchProductsByGid(recommendations) {
        const token = findStorefrontToken();
        if (!token) {
          return { products: [], error: 'missing_token' };
        }
  
        // Normalize any non-GID inputs (numeric IDs, URLs, or handles)
        const { productGids, variantGids, handles, explanationMap } = normalizeRecommendationIds(recommendations);
        if (!productGids.length && !variantGids.length && !handles.length) {
          console.warn('No valid product identifiers found in recommendations:', recommendations);
          return { products: [], error: 'no_valid_ids' };
        }
        const storeRoot = (window.Shopify && window.Shopify.routes && window.Shopify.routes.root) || '/';

        const productSelection = `
          id
          handle
          title
          onlineStoreUrl
          featuredImage { url altText }
          priceRange { minVariantPrice { amount currencyCode } }
          variants(first: 10) {
            edges {
              node {
                id
                title
                availableForSale
                price { amount currencyCode }
              }
            }
          }
        `;

        const queryGetProductById = `
          query getProductById($id: ID!) {
            product(id: $id) {
              ${productSelection}
            }
          }
        `;

        const queryGetProductByHandle = `
          query getProductByHandle($handle: String!) {
            product(handle: $handle) {
              ${productSelection}
            }
          }
        `;

        const queryGetProductByVariantId = `
          query getProductByVariantId($id: ID!) {
            productVariant(id: $id) {
              id
              product {
                ${productSelection}
              }
            }
          }
        `;
  
        try {
          const doFetch = (query, variables) =>
            fetch(`${storeRoot}api/2024-07/graphql.json`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-Shopify-Storefront-Access-Token': token
              },
              body: JSON.stringify({ query, variables })
            }).then((res) => {
              if (!res.ok) throw new Error(`GraphQL returned ${res.status}`);
              return res.json();
            });

          const toProductCard = (productNode, preferredVariantId, explanation) => {
            const variantEdges = productNode?.variants?.edges || [];
            const variants = variantEdges.map((e) => e.node).filter(Boolean);
            const preferredVariant =
              (preferredVariantId && variants.find((v) => v.id === preferredVariantId)) ||
              variants.find((v) => v.availableForSale) ||
              variants[0] ||
              null;

            const expl =
              explanation ||
              explanationMap.get(productNode?.id) ||
              explanationMap.get(productNode?.handle) ||
              (preferredVariantId ? explanationMap.get(preferredVariantId) : '') ||
              '';

            return {
              id: productNode.id,
              handle: productNode.handle,
              title: productNode.title,
              url: productNode.onlineStoreUrl || (productNode.handle ? `${storeRoot}products/${productNode.handle}` : null),
              image: productNode.featuredImage?.url || null,
              imageAlt: productNode.featuredImage?.altText || productNode.title,
              price:
                preferredVariant?.price?.amount ||
                productNode.priceRange?.minVariantPrice?.amount ||
                null,
              currency:
                preferredVariant?.price?.currencyCode ||
                productNode.priceRange?.minVariantPrice?.currencyCode ||
                null,
              variantId: preferredVariant?.id || null,
              variants,
              explanation: expl
            };
          };

          const requests = [];

          // Fetch each Product by ID
          productGids.forEach((productId) => {
            requests.push(
              doFetch(queryGetProductById, { id: productId })
                .then((json) => json?.data?.product || null)
                .then((product) => (product ? toProductCard(product, null, explanationMap.get(productId)) : null))
                .catch(() => null)
            );
          });

          // Fetch each Product by Variant ID, then map to parent product
          variantGids.forEach((variantId) => {
            requests.push(
              doFetch(queryGetProductByVariantId, { id: variantId })
                .then((json) => json?.data?.productVariant || null)
                .then((pv) => (pv && pv.product ? toProductCard(pv.product, pv.id, explanationMap.get(variantId)) : null))
                .catch(() => null)
            );
          });

          // Fetch by handle
          handles.forEach((handle) => {
            requests.push(
              doFetch(queryGetProductByHandle, { handle })
                .then((json) => json?.data?.product || null)
                .then((product) => (product ? toProductCard(product, null, explanationMap.get(handle)) : null))
                .catch(() => null)
            );
          });

          const results = await Promise.all(requests);
          // Dedupe by product id
          const seen = new Set();
          const products = results
            .filter(Boolean)
            .filter((p) => {
              if (!p?.id) return false;
              if (seen.has(p.id)) return false;
              seen.add(p.id);
              return true;
            });

          return { products, error: null };
        } catch (error) {
          console.error('Failed to load product data:', error);
          return { products: [], error: 'graphql_error' };
        }
      }
  
      function formatMoney(amount, currency) {
        if (!amount) return '';
        const number = Number(amount);
        if (!Number.isFinite(number)) return '';
        try {
          return new Intl.NumberFormat(undefined, {
            style: 'currency',
            currency: currency || 'USD',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }).format(number);
        } catch (_error) {
          return `${currency || 'USD'} ${number.toFixed(2)}`;
        }
      }
  
      function renderRecommendations(products, options = {}) {
        if (!resultsGrid || !resultsSection) return;
  
        quiz.classList.add('quiz-has-results');
        safeSetStatus('');
  
        resultsGrid.innerHTML = '';
        resultsSection.hidden = false;
  
        if (!products.length) {
          const message = document.createElement('div');
          message.className = options.type === 'error' ? 'quiz-results-error' : 'quiz-results-empty';
          message.innerHTML =
            options.type === 'error'
              ? `<strong>We hit a snag.</strong> ${options.message || 'Please refresh and try again, or contact support if it keeps happening.'}`
              : `<strong>We couldn't load your recommendations.</strong> ${options.message || 'Please try again in a moment.'}`;
          resultsGrid.appendChild(message);
          resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          return;
        }
  
        products.forEach((product) => {
          const card = document.createElement('article');
          card.className = 'quiz-card';
  
          if (product.image) {
            const img = document.createElement('img');
            img.className = 'quiz-card-image';
            img.src = product.image;
            img.alt = product.imageAlt || product.title;
            img.loading = 'lazy';
            card.appendChild(img);
          }
  
          const body = document.createElement('div');
          body.className = 'quiz-card-body';
  
          const title = document.createElement('h3');
          title.className = 'quiz-card-title';
          title.textContent = product.title || 'Recommended product';
          body.appendChild(title);
  
          // Add explanation if available
          if (product.explanation) {
            const explanation = document.createElement('p');
            explanation.className = 'quiz-card-explanation';
            explanation.textContent = product.explanation;
            body.appendChild(explanation);
          }
  
          if (product.price) {
            const price = document.createElement('p');
            price.className = 'quiz-card-price';
            price.textContent = formatMoney(product.price, product.currency);
            body.appendChild(price);
          }
  
          const actions = document.createElement('div');
          actions.className = 'quiz-card-actions';
  
          const addButton = document.createElement('button');
          addButton.type = 'button';
          addButton.className = 'quiz-card-button primary';
          addButton.textContent = product.variantId ? 'Add to cart' : 'See product options';
          addButton.disabled = !product.variantId;
          addButton.dataset.variantId = product.variantId || '';
          addButton.dataset.productTitle = product.title || '';
          addButton.addEventListener('click', () => handleAddToCart(addButton));
          actions.appendChild(addButton);
  
          if (product.url) {
            const linkButton = document.createElement('a');
            linkButton.href = product.url;
            linkButton.className = 'quiz-card-button secondary';
            linkButton.textContent = 'View details';
            linkButton.target = '_blank';
            linkButton.rel = 'noopener noreferrer';
            actions.appendChild(linkButton);
          }
  
          body.appendChild(actions);
          card.appendChild(body);
          resultsGrid.appendChild(card);
        });
  
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
  
      async function handleAddToCart(button) {
        const variantGid = button.dataset.variantId;
        if (!variantGid) return;
  
        const variantIdNumeric = variantGid.split('/').pop();
        if (!variantIdNumeric) return;
  
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = 'Adding...';
        safeSetStatus('');
  
        try {
          const storeRoot = (window.Shopify && window.Shopify.routes && window.Shopify.routes.root) || '/';
          const response = await fetch(`${storeRoot}cart/add.js`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              items: [
                {
                  id: variantIdNumeric,
                  quantity: 1
                }
              ]
            })
          });
  
          if (!response.ok) {
            throw new Error(`Cart API returned ${response.status}`);
          }
  
          const productTitle = button.dataset.productTitle || 'product';
          safeSetStatus(`✅ ${productTitle} was added to your cart.`);
          button.textContent = 'Added!';
          setTimeout(() => {
            button.textContent = originalText;
            button.disabled = false;
          }, 2000);
        } catch (error) {
          console.error('Add to cart failed:', error);
          safeSetStatus('We couldn\'t add this item to your cart. Please try again.');
          button.textContent = originalText;
          button.disabled = false;
        }
      }
  
      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          if (!validateStep(currentStep)) return;
  
          if (currentStep === 0) {
            const choice = steps[0]?.querySelector('input[type="radio"]:checked');
            if (choice && choice.value === 'parts') {
              redirectToParts();
              return;
            }
          }
  
          if (totalSteps) {
            const nextIndex = Math.min(currentStep + 1, totalSteps - 1);
            if (nextIndex !== currentStep) {
              showStep(nextIndex);
              safeSetStatus('');
            }
          }
        });
      }
  
      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          if (!totalSteps) return;
          const prevIndex = Math.max(currentStep - 1, 0);
          if (prevIndex !== currentStep) {
            showStep(prevIndex);
            safeSetStatus('');
          }
        });
      }
  
      if (form) {
        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!validateStep(currentStep)) return;
  
          const payload = gatherPayload();
  
          safeSetStatus('Building your personalized recommendation...');
          if (submitBtn) submitBtn.disabled = true;
          if (prevBtn) prevBtn.disabled = true;
          if (nextBtn) nextBtn.disabled = true;
  
          try {
            const response = await fetch(ENDPOINT, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload)
            });
  
            const text = await response.text();
            if (!response.ok) {
              throw new Error(`Server responded with ${response.status}: ${text}`);
            }
  
            const parsed = safeParseJSON(text);
            const recommendations = extractProductRecommendations(parsed);
  
            if (recommendations.length) {
              const { products, error } = await fetchProductsByGid(recommendations);
              if (products.length) {
                renderRecommendations(products);
              } else if (error === 'missing_token') {
                renderRecommendations([], {
                  type: 'error',
                  message: 'We need a Storefront API access token to load the recommended products. Add it as data-storefront-token on the quiz container or meta[name="storefront-access-token"].'
                });
              } else {
                renderRecommendations([], {
                  type: 'error',
                  message: 'We couldn\'t load product details right now. Please refresh or try again shortly.'
                });
              }
            } else {
              renderRecommendations([], {
                type: 'error',
                message: 'The recommendation service returned no product IDs. Please try again soon.'
              });
            }
          } catch (error) {
            console.error(error);
            safeSetStatus('Something went wrong while sending your answers. Please try again.');
            if (submitBtn) submitBtn.disabled = false;
            if (prevBtn) prevBtn.disabled = currentStep <= 0;
            if (nextBtn) nextBtn.disabled = false;
            return;
          }
  
          if (submitBtn) submitBtn.disabled = false;
          if (prevBtn) prevBtn.disabled = true;
          if (nextBtn) nextBtn.disabled = true;
          form.classList.add('quiz-complete');
        });
      }
  
      showStep(0);
    })();
  </script>